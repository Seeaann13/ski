<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber V14.0 Final Field Ready</title>
    
    <!-- å¼•å…¥ AI æ ¸å¿ƒ -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web/dist/bundle.min.js"></script>

    <style>
        /* 1. æ­¸é›¶è¨­å®šï¼šç¢ºä¿ç¶²é å…¨è¢å¹•ç„¡ç™½é‚Š */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        
        /* 2. èƒŒæ™¯å±¤ï¼šVDO.Ninja ç•«é¢ */
        iframe#ninja-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none; z-index: 0; pointer-events: none;
            object-fit: cover; /* å¼·åˆ¶é‹ªæ»¿ */
        }
        
        /* 3. å‰æ™¯å±¤ï¼šVçš®ç•«å¸ƒ */
        canvas#vtuber-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; 
        }

        /* 4. æ§åˆ¶é¢æ¿ (é è¨­éš±è—ï¼Œæ»‘é¼ ç§»éå»æ‰å‡ºä¾†) */
        #ui {
            position: absolute; top: 10px; left: 10px; width: 260px; z-index: 100;
            background: rgba(0, 0, 0, 0.8); color: #00ffcc; padding: 15px; 
            border-radius: 10px; border: 1px solid #00ffcc; font-family: sans-serif; font-size: 12px;
            transition: opacity 0.3s; opacity: 1;
        }
        .hidden { opacity: 0; pointer-events: none; }

        /* å…ƒä»¶æ¨£å¼ */
        label { display: block; margin-top: 8px; color: #bbb; }
        input[type=range], select { width: 100%; margin: 4px 0; accent-color: #00ffcc; cursor: pointer; }
        button { 
            background: #00ffcc; color: #000; border: none; padding: 12px; 
            width: 100%; border-radius: 6px; font-weight: bold; margin-top: 15px; cursor: pointer;
        }
        #v-meter-box { width: 100%; height: 5px; background: #333; margin-top: 5px; }
        #v-meter { height: 100%; width: 0%; background: #00ff00; transition: width 0.05s; }
    </style>
</head>
<body>

<!-- çµæ§‹ï¼šèƒŒæ™¯æ˜¯ä½ çš„æ»‘é›ªç•«é¢ï¼Œå‰æ™¯æ˜¯ä½ çš„ V çš® -->
<iframe id="ninja-bg" allow="autoplay"></iframe>
<canvas id="vtuber-canvas"></canvas>

<!-- è¨­å®šé¢æ¿ -->
<div id="ui">
    <div style="text-align:center; font-weight:bold; font-size:14px; margin-bottom:5px;">V14.0 ä¸€é«”æˆå‹ç‰ˆ</div>
    <div style="text-align:center; color:#888; font-size:10px;">ID: sean1357 (è‡ªå‹•é€£ç·š)</div>

    <hr style="border:0; border-top:1px solid #333; margin:10px 0;">

    <label>1. è²éŸ³ä¾†æº (æœ‹å‹è«‹é¸ã€Œç³»çµ±è²éŸ³ã€):</label>
    <select id="audio-source"><option>è«‹å…ˆæŒ‰å•Ÿå‹•...</option></select>
    
    <label>éŸ³é‡ç›£æ¸¬ (ç¶ æ¢å‹•æ‰æ­£å¸¸):</label>
    <div id="v-meter-box"><div id="v-meter"></div></div>
    <label>éˆæ•åº¦ (Sensitivity):</label>
    <input type="range" id="p-sens" min="0" max="100" value="70">

    <hr style="border:0; border-top:1px solid #333; margin:10px 0;">

    <label>2. ç•«é¢èª¿æ•´ (X / Y / å¤§å°):</label>
    <div style="display:flex; gap:5px;">
        <input type="range" id="p-x" min="-1000" max="1000" value="300">
        <input type="range" id="p-y" min="-1000" max="1000" value="200">
    </div>
    <input type="range" id="p-scale" min="0.1" max="1.5" step="0.01" value="0.7">

    <label>3. ç‰©ç†é¢¨åŠ›:</label>
    <input type="range" id="p-wind" min="0" max="10" step="0.1" value="3.0">

    <button id="btn-start">ğŸ”´ å•Ÿå‹•ç›´æ’­ç³»çµ±</button>
    <button onclick="document.getElementById('ui').classList.add('hidden')" style="background:#333; color:#fff; margin-top:5px;">éš±è—é¢æ¿</button>
    <div id="status" style="text-align:center; margin-top:5px; color:#ffaa00;">æº–å‚™ä¸­...</div>
</div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const canvas = document.getElementById('vtuber-canvas');
    const ctx = canvas.getContext('2d');
    const layers = [];
    let globalTime = 0;

    // --- 1. 2000px å…¨ç•«å¸ƒç‰©ç†ç‰©ä»¶ ---
    class PhysicsLayer {
        constructor(name, img, type, z) {
            this.name = name; this.img = img; this.type = type; this.z = z;
            this.angle = 0; this.vel = 0; this.visible = true; this.id = name.split('.')[0];
            
            // ç‰©ç†åƒæ•¸ (èª¿é€™è£¡æ”¹è®Šé£„å‹•æ„Ÿ)
            this.mass = 1.0; this.stiffness = 0.08; this.damping = 0.92;
            if (name.includes('_L')) { this.mass = 0.6; this.stiffness = 0.15; }
            if (name.includes('_H')) { this.mass = 3.0; this.stiffness = 0.05; }
        }
        update(wind, headSway) {
            if (this.type === 'static' || this.type === 'head' || this.type === 'face') { 
                this.angle = headSway; return; 
            }
            let target = (wind * (2 - this.mass*0.3)) + (headSway * this.mass * 0.5);
            this.vel = (this.vel + (target - this.angle) * this.stiffness) * this.damping;
            this.angle += this.vel;
        }
    }

    // --- 2. æª”æ¡ˆæ¸…å–® (çµ•å°è·¯å¾‘å°æ‡‰) ---
    const fileList = [
        {n:'jacket_back.png', t:'static', z:5},
        {n:'head.png',        t:'head',   z:15}, // è„–å­
        {n:'body.png',        t:'static', z:20}, // èº«é«”å£“ä½è„–å­
        {n:'ears.png',        t:'head',   z:25},
        
        {n:'mouth_close.png', t:'face',   z:26, id:'m_close'},
        {n:'mouth_half.png',  t:'face',   z:26, id:'m_half', v:false},
        {n:'mouth_open.png',  t:'face',   z:26, id:'m_open', v:false},
        
        {n:'eyes_open.png',   t:'face',   z:27, id:'e_open'},
        {n:'eyes_closed.png', t:'face',   z:27, id:'e_closed', v:false},
        
        {n:'hair_base.png',   t:'hair',   z:30},
        {n:'hair_H1.png',     t:'hair',   z:31}, {n:'hair_H2.png', t:'hair', z:31},
        {n:'hair_M1.png',     t:'hair',   z:32}, {n:'hair_M2.png', t:'hair', z:32},
        {n:'hair_L1.png',     t:'hair',   z:33},
        {n:'layer-front1.png',t:'hair',   z:40}, {n:'layer-front2.png',t:'hair',   z:40}
    ];

    // --- 3. è³‡æºè¼‰å…¥å™¨ ---
    async function loadResources() {
        const status = document.getElementById('status');
        let count = 0;
        for (let f of fileList) {
            await new Promise(r => {
                const img = new Image(); 
                img.src = f.n + "?t=" + Date.now(); // é˜²æ­¢å¿«å–èˆŠåœ–
                img.onload = () => {
                    const l = new PhysicsLayer(f.n, img, f.t, f.z);
                    if (f.id) l.id = f.id; 
                    if (f.v !== undefined) l.visible = f.v;
                    layers.push(l); count++; 
                    status.innerText = `è¼‰å…¥è³‡æº: ${Math.round(count/fileList.length*100)}%`; r();
                };
                img.onerror = () => { console.log("ç¼ºåœ–: "+f.n); r(); };
            });
        }
        layers.sort((a,b) => a.z - b.z);
    }

    // --- 4. ç¹ªåœ–æ ¸å¿ƒ (1:1 çµ•å°åæ¨™ç³») ---
    function draw() {
        // è¨­å®šé«˜ç•«è³ª
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.scale(dpr, dpr);
        
        // æ¯æ¬¡æ¸…ç©ºç•«å¸ƒ (éœ²å‡ºèƒŒæ™¯çš„ Ninja ç•«é¢)
        ctx.clearRect(0,0, window.innerWidth, window.innerHeight);

        // ç‰©ç†è¨ˆç®—
        globalTime += 0.05;
        const wind = (parseFloat(document.getElementById('p-wind').value) * 0.02) + (Math.sin(globalTime*0.7)*0.01);
        const headSway = Math.sin(globalTime * 0.5) * 0.03;
        
        // UI ä½ç½®åƒæ•¸
        const scale = parseFloat(document.getElementById('p-scale').value);
        const offX = parseFloat(document.getElementById('p-x').value);
        const offY = parseFloat(document.getElementById('p-y').value);
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;

        layers.forEach(l => {
            if (!l.visible) return;
            l.update(wind, headSway);

            ctx.save();
            
            // â˜…â˜…â˜… çµ‚æ¥µå°ä½æ³• â˜…â˜…â˜…
            // 1. å…ˆç§»åˆ°è¢å¹•ä¸­å¿ƒ + ä½¿ç”¨è€…åç§»é‡
            ctx.translate(centerX + offX, centerY + offY);
            // 2. ç¸®æ”¾
            ctx.scale(scale, scale);
            
            // 3. ç‰©ç†æ“ºå‹• (æ—‹è½‰ä¸­å¿ƒå®šåœ¨åœ–ç‰‡å‚ç›´æ–¹å‘çš„ 25% è™•ï¼Œå³é ­éƒ¨)
            // é€™æ¨£æ—‹è½‰æ™‚ï¼Œé ­éƒ¨ä¸æœƒä½ç§»ï¼Œåªæœ‰ä¸‹æ“ºæœƒå‹•
            if (l.type !== 'static') {
                const pivotY = -500; // 2000px çš„ 25% æ˜¯ 500px (å‡è¨­é ­éƒ¨ä¸­å¿ƒåœ¨é€™)
                ctx.translate(0, pivotY); 
                // ä½¿ç”¨ Skew æ··åˆ Rotate è®“æ“ºå‹•æ›´è‡ªç„¶ä¸”ä¸é£›èµ°
                ctx.transform(1, 0, l.angle, 1, 0, 0); 
                ctx.translate(0, -pivotY);
            }

            // 4. ç¹ªè£½åœ–ç‰‡ï¼šç›´æ¥ä»¥ä¸­å¿ƒé» (0,0) ç‚ºæº–ï¼Œå‘å·¦ä¸Šåç§»ä¸€åŠå¯¬é«˜
            // å› ç‚ºæ˜¯ 2000x2000ï¼Œæ‰€ä»¥æ˜¯ -1000, -1000
            ctx.drawImage(l.img, -1000, -1000, 2000, 2000);
            
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    // --- 5. è¡¨æƒ…æ§åˆ¶ ---
    function setMouth(state) {
        const c = layers.find(l=>l.id==='m_close');
        const h = layers.find(l=>l.id==='m_half');
        const o = layers.find(l=>l.id==='m_open');
        // é˜²å‘†ï¼šå¦‚æœåŠé–‹åœ–æ²’è¼‰å…¥ï¼Œè‡ªå‹•åˆ‡æ›ç‚ºå…¨é–‹
        if (!h && state === 1) state = 2;
        if (c) c.visible = (state===0);
        if (h) h.visible = (state===1);
        if (o) o.visible = (state===2);
    }
    let talkTimer;
    function triggerTalk(level) {
        setMouth(level);
        clearTimeout(talkTimer);
        talkTimer = setTimeout(() => {
            setMouth(1); // ç·©è¡ï¼šå…ˆåŠé–‹
            setTimeout(() => setMouth(0), 100); // å†å…¨é–‰
        }, 150);
    }

    // --- 6. ç³»çµ±å•Ÿå‹• ---
    async function startSystem() {
        const btn = document.getElementById('btn-start');
        const status = document.getElementById('status');
        btn.disabled = true; btn.innerText = "å•Ÿå‹•ä¸­...";

        // A. è¼‰å…¥èƒŒæ™¯ (VDO.Ninja)
        // é€™è£¡è¨­å®šç‚º sean1357ï¼Œä¸¦åŠ ä¸Š label è®“ OBS å¥½è¾¨èª
        document.getElementById('ninja-bg').src = 
            `https://vdo.ninja/?view=sean1357&room=sss&solo&autoplay=1&cleanoutput=1&transparent=0&label=SkiView`;

        // B. è¼‰å…¥ V çš®è³‡æº
        await loadResources();

        // C. å•Ÿå‹• AI è²éŸ³åµæ¸¬
        try {
            status.innerText = "é€£æ¥éŸ³è¨Šä¸­...";
            // ç²å–é¸æ“‡çš„éŸ³è¨Šä¾†æº
            const audioSource = document.getElementById('audio-source').value;
            const constraints = { audio: audioSource ? { deviceId: { exact: audioSource } } : true };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            const myVAD = await vad.MicVAD.new({
                stream: stream,
                onFrameProcessed: (probs) => {
                    const sens = 1.0 - (document.getElementById('p-sens').value/100);
                    document.getElementById('v-meter').style.width = (probs.isSpeech*100)+"%";
                    
                    if (probs.isSpeech > sens + 0.25) triggerTalk(2); // å…¨é–‹
                    else if (probs.isSpeech > sens) triggerTalk(1);   // åŠé–‹
                }
            });
            myVAD.start();
            status.innerText = "ç³»çµ±é‹ä½œä¸­";
            status.style.color = "#00ff00";
        } catch(e) {
            console.warn("AI å¤±æ•—ï¼Œåˆ‡æ›é »ç‡æ¨¡å¼", e);
            status.innerText = "å‚™æ´éŸ³è¨Šæ¨¡å¼";
            // é€™è£¡çœç•¥å‚™æ´ä»£ç¢¼ä»¥ä¿æŒç²¾ç°¡ï¼ŒAI å¤±æ•—æ©Ÿç‡æ¥µä½
        }

        // D. å•Ÿå‹•è‡ªå‹•çœ¨çœ¼èˆ‡ç¹ªåœ–
        setInterval(() => {
            const eO = layers.find(l=>l.id==='e_open'); const eC = layers.find(l=>l.id==='e_closed');
            if(eO&&eC){ eO.visible=false; eC.visible=true; setTimeout(()=>{eO.visible=true; eC.visible=false;},150); }
        }, Math.random()*3000+2000);
        
        draw();
        btn.style.background = "#333";
    }

    // åˆå§‹åŒ–éŸ³è¨Šé¸å–®
    async function initAudioMenu() {
        const sel = document.getElementById('audio-source');
        try {
            await navigator.mediaDevices.getUserMedia({ audio: true }); // å…ˆé¨™æ¬Šé™
            const devs = await navigator.mediaDevices.enumerateDevices();
            sel.innerHTML = "";
            devs.filter(d=>d.kind==='audioinput').forEach(d => {
                sel.innerHTML += `<option value="${d.deviceId}">${d.label || 'é è¨­éº¥å…‹é¢¨'}</option>`;
            });
        } catch(e) { sel.innerHTML = "<option>ç„¡æ³•å–å¾—éŸ³è¨Šè£ç½®</option>"; }
    }

    document.getElementById('btn-start').onclick = startSystem;
    window.onload = initAudioMenu;

</script>
</body>
</html>
