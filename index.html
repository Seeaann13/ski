<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber Solo Pro V3.1</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; background: #111; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        .avatar-group {
            position: absolute; bottom: -5px; right: -10px;
            width: 45vw; height: auto; pointer-events: none; z-index: 10;
        }

        .part {
            position: absolute; bottom: 0; right: 0;
            width: 100%; height: auto;
            opacity: 0; /* 預設全透明 */
            transition: transform 0.05s linear;
        }

        #base-body { z-index: 11; opacity: 1; } /* 底層永遠顯示 */
        #mouth-part { z-index: 12; } 
        #eyes-part { z-index: 13; }

        #ui-layer {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 12px;
            color: white; display: flex; flex-direction: column; gap: 10px; width: 260px;
            backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2);
        }

        button { padding: 10px; background: #00d2ff; border: none; border-radius: 6px; color: #003344; font-weight: 800; cursor: pointer; }
        .adjust-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 5px; }
        .btn-sm { padding: 5px 12px; background: #555; color: white; border-radius: 4px; font-weight: bold; }
        select { padding: 8px; border-radius: 4px; background: #333; color: white; border: 1px solid #666; width: 100%; }
        .hint { font-size: 11px; color: #00d2ff; }
    </style>
</head>
<body>

<div id="container">
    <video id="camera-video" autoplay playsinline muted></video>
    
    <div class="avatar-group">
        <img id="base-body" class="part" src="idle.png">
        <img id="mouth-part" class="part" src="mouth_open.png">
        <img id="eyes-part" class="part" src="eyes_closed.png">
    </div>
    
    <div id="ui-layer">
        <div style="text-align:center; font-weight:900; color:#00d2ff;">SKI-VTUBER PRO V3.1</div>
        
        <select id="cam-select"><option>偵測相機中...</option></select>
        <button id="start-btn">啟動系統</button>
        
        <label class="hint">零件對位調整：</label>
        <div class="adjust-row">
            嘴巴: <div>
                <button class="btn-sm" onclick="adjust('mouth', -1)">↑</button>
                <button class="btn-sm" onclick="adjust('mouth', 1)">↓</button>
            </div>
        </div>
        <div class="adjust-row">
            眼睛: <div>
                <button class="btn-sm" onclick="adjust('eyes', -1)">↑</button>
                <button class="btn-sm" onclick="adjust('eyes', 1)">↓</button>
            </div>
        </div>

        <button id="test-blink" style="background:#ffaa00;">手動測試眨眼 (按住不放)</button>

        <div style="font-size:12px;">麥克風靈敏度: <input type="range" id="sens-slider" min="0" max="100" value="45"></div>
        <button id="hide-ui-btn" style="background:#cc3333; color:white;">隱藏介面</button>
    </div>
</div>

<script>
    const mouth = document.getElementById('mouth-part');
    const eyes = document.getElementById('eyes-part');
    const video = document.getElementById('camera-video');
    const camSelect = document.getElementById('cam-select');
    const sensSlider = document.getElementById('sens-slider');
    
    let isTalking = false, talkTimeout = null, currentStream = null;
    let offsets = { mouth: 0, eyes: 0 };

    // --- 預載圖片防止眨眼閃爍 ---
    function preloadImages() {
        ['idle.png', 'mouth_open.png', 'eyes_closed.png'].forEach(src => {
            const img = new Image();
            img.src = src;
        });
    }

    function adjust(part, val) {
        offsets[part] += val;
        const target = (part === 'mouth') ? mouth : eyes;
        target.style.transform = `translateY(${offsets[part]}px)`;
    }

    // --- 測試眨眼按鈕 ---
    const testBlinkBtn = document.getElementById('test-blink');
    testBlinkBtn.onmousedown = testBlinkBtn.ontouchstart = () => eyes.style.opacity = 1;
    testBlinkBtn.onmouseup = testBlinkBtn.ontouchend = () => eyes.style.opacity = 0;

    async function initCameras() {
        try {
            await navigator.mediaDevices.getUserMedia({ video: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            camSelect.innerHTML = '';
            videoDevices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Camera ${camSelect.length + 1}`;
                camSelect.appendChild(opt);
            });
        } catch (e) { console.log("Cam init error"); }
    }

    document.getElementById('start-btn').onclick = async () => {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        const videoStream = await navigator.mediaDevices.getUserMedia({
            video: { deviceId: { exact: camSelect.value } }
        });
        video.srcObject = videoStream;
        currentStream = videoStream;

        const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(audioStream);
        const processor = audioCtx.createScriptProcessor(2048, 1, 1);
        
        analyser.fftSize = 1024;
        source.connect(analyser);
        analyser.connect(processor);
        processor.connect(audioCtx.destination);
        
        processor.onaudioprocess = () => {
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            const volume = data.reduce((a, b) => a + b) / data.length;
            const threshold = 105 - parseInt(sensSlider.value);
            
            if (volume > threshold) {
                isTalking = true;
                mouth.style.opacity = 1;
                if (talkTimeout) clearTimeout(talkTimeout);
                talkTimeout = setTimeout(() => {
                    isTalking = false;
                    mouth.style.opacity = 0;
                }, 200);
            }
        };

        blinkLoop();
        document.getElementById('start-btn').innerText = "系統運作中";
        document.getElementById('start-btn').style.background = "#55ff55";
    };

    function blinkLoop() {
        const nextBlink = Math.random() * 4000 + 2000;
        setTimeout(() => {
            eyes.style.opacity = 1;
            setTimeout(() => {
                eyes.style.opacity = 0;
                blinkLoop();
            }, 180); 
        }, nextBlink);
    }

    preloadImages();
    initCameras();
    document.getElementById('container').onclick = (e) => {
        if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
            document.getElementById('ui-layer').classList.toggle('hidden');
        }
    };
    document.getElementById('hide-ui-btn').onclick = () => document.getElementById('ui-layer').classList.add('hidden');
</script>

</body>
</html>        const audioCtx = new AudioContext();
        const analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(audioStream);
        const processor = audioCtx.createScriptProcessor(2048, 1, 1);
        
        analyser.fftSize = 1024;
        source.connect(analyser);
        analyser.connect(processor);
        processor.connect(audioCtx.destination);
        
        processor.onaudioprocess = () => {
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            const volume = data.reduce((a, b) => a + b) / data.length;
            
            const threshold = 105 - parseInt(sensSlider.value);
            
            if (volume > threshold) {
                isTalking = true;
                mouth.style.display = 'block';
                if (talkTimeout) clearTimeout(talkTimeout);
                // 嘴巴張開後至少維持 200ms，讓動作不閃爍
                talkTimeout = setTimeout(() => {
                    isTalking = false;
                    if(!isBlinking) mouth.style.display = 'none';
                }, 200);
            }
        };

        blinkLoop();
        document.getElementById('start-btn').innerText = "系統運作中";
        document.getElementById('start-btn').style.background = "#55ff55";
    };

    // --- 自動眨眼循環 ---
    function blinkLoop() {
        const nextBlink = Math.random() * 4000 + 2000;
        setTimeout(() => {
            isBlinking = true;
            eyes.style.display = 'block';
            setTimeout(() => {
                isBlinking = false;
                eyes.style.display = 'none';
                blinkLoop();
            }, 180); // 眨眼時間
        }, nextBlink);
    }

    // UI 控制
    initCameras();
    document.getElementById('container').onclick = (e) => {
        if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
            document.getElementById('ui-layer').classList.toggle('hidden');
        }
    };
    document.getElementById('hide-ui-btn').onclick = () => document.getElementById('ui-layer').classList.add('hidden');
</script>

</body>
</html>                if (talkTimeout) clearTimeout(talkTimeout);
                talkTimeout = setTimeout(() => {
                    isTalking = false;
                    updateAvatar();
                }, 250); // 說話結束後，嘴巴多維持 0.25 秒，避免閃爍
            }
            updateAvatar();
        };
        document.getElementById('start-mic').innerText = "麥克風偵測中...";
        document.getElementById('start-mic').style.background = "#55ff55";
        blinkLoop();
    };

    function updateAvatar() {
        // 邏輯優先級：眨眼中顯示眨眼，其餘根據說話狀態切換
        if (isBlinking) {
            avatar.src = imgs.blink;
        } else {
            avatar.src = isTalking ? imgs.talk : imgs.idle;
        }
    }

    function blinkLoop() {
        // 隨機眨眼
        setTimeout(() => {
            isBlinking = true;
            updateAvatar();
            setTimeout(() => {
                isBlinking = false;
                updateAvatar();
                blinkLoop();
            }, 180); // 眨眼時間
        }, Math.random() * 4000 + 2000);
    }

    // 初始化
    updateCamList();
    document.getElementById('container').onclick = (e) => {
        if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
            document.getElementById('ui-layer').classList.toggle('hidden');
        }
    };
    document.getElementById('hide-ui-btn').onclick = () => document.getElementById('ui-layer').classList.add('hidden');
</script>
</body>
</html>
