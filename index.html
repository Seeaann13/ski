<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber V8.4 FINAL - 3D Layered</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; z-index: 1; }

        /* V皮整體容器 */
        #avatar-container { position: absolute; bottom: -5px; right: -5px; width: 45vw; height: auto; pointer-events: none; z-index: 10; }

        /* 零件層級與動畫 */
        .part { position: absolute; bottom: 0; left: 0; width: 100%; height: auto; transition: transform 0.1s ease-out; }

        /* 堆疊順序：從底層到頂層 */
        #body { z-index: 11; animation: breathe 4s ease-in-out infinite; } /* 1. 外套前半部 */
        #out_jacket { z-index: 12; animation: breathe 4s ease-in-out infinite; } /* 2. 外套後部 (擋住頭頸部後面) */
        #head { z-index: 13; animation: head-sway 5s ease-in-out infinite; transform-origin: bottom center; } /* 3. 頭部底座 */
        #ears { z-index: 14; animation: ear-twitch 2.5s ease-in-out infinite; transform-origin: center top; } /* 4. 耳朵 */
        #hair { z-index: 15; animation: hair-flutter 3.5s ease-in-out infinite; transform-origin: center top; } /* 5. 瀏海 */
        #mouth_close { z-index: 16; } /* 6. 閉嘴貼紙 */
        #eyes_closed { z-index: 17; opacity: 0; visibility: hidden; } /* 7. 閉眼貼紙 */

        /* 動畫效果碼 - 保持不變 */
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes head-sway { 0%, 100% { transform: rotate(0deg) translateY(0); } 50% { transform: rotate(0.8deg) translateY(-3px); } }
        @keyframes ear-twitch { 0%, 80% { transform: rotate(0deg); } 85% { transform: rotate(2deg); } 95% { transform: rotate(-1deg); } }
        @keyframes hair-flutter { 0%, 100% { transform: skewX(0.5deg) translateX(0); } 50% { transform: skewX(1.8deg) translateX(3px); } }

        /* UI - 保持不變 */
        #ui { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.85); color: #00d2ff; padding: 15px; border-radius: 12px; width: 260px; border: 1px solid #00d2ff; }
        button { padding: 10px; background: #00d2ff; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; width: 100%; margin: 5px 0; }
        .adj-box { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px; margin-top: 5px; font-size: 11px; color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="container">
    <video id="camera-video" autoplay playsinline muted></video>
    
    <div id="avatar-container">
        <!-- 檔案名稱適應你的 Procreate 輸出 -->
        <img id="body" class="part" src="body.png">
        <img id="out_jacket" class="part" src="Out_jacket.png"> <!-- 新增的外套後部 -->
        <img id="head" class="part" src="head.png">
        <img id="ears" class="part" src="ears.png">
        <img id="hair" class="part" src="hair.png">
        <img id="mouth_close" class="part" src="mouth_close.png">
        <img id="eyes_closed" class="part" src="eyes_closed.png">
    </div>
    
    <div id="ui">
        <b>SKI-VTUBER V8.4 FINAL</b><br>
        <button id="start-btn">1. 啟動系統</button>
        <div class="adj-box">
            調整高度：<br>
            嘴巴: <button onclick="adj('mouth_close',-2)" style="width:30px; padding:2px;">↑</button><button onclick="adj('mouth_close',2)" style="width:30px; padding:2px;">↓</button>
            眼睛: <button onclick="adj('eyes_closed',-2)" style="width:30px; padding:2px;">↑</button><button onclick="adj('eyes_closed',2)" style="width:30px; padding:2px;">↓</button>
        </div>
        <div style="font-size:10px; color:white; margin:5px 0;">麥克風靈敏度: <input type="range" id="sens" value="45" style="width:100px;"></div>
        <button id="hide-btn" style="background:#cc3333; color:white;">2. 直播準備 (隱藏介面)</button>
    </div>
</div>

<script>
    const head = document.getElementById('head'); 
    const mouth = document.getElementById('mouth_close'); 
    const eyes = document.getElementById('eyes_closed');
    let offsets = { mouth_close: 0, eyes_closed: 0 };

    function adj(p, v) { 
        offsets[p] += v; 
        document.getElementById(p).style.top = offsets[p] + 'px'; 
    }

    function setV(el, s) { 
        el.style.opacity = s ? "1" : "0"; 
        el.style.visibility = s ? "visible" : "hidden"; 
    }

    document.getElementById('start-btn').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, audio: true 
            });
            document.getElementById('camera-video').srcObject = stream;

            const audioCtx = new AudioContext();
            const analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaStreamSource(stream);
            const proc = audioCtx.createScriptProcessor(2048, 1, 1);
            src.connect(analyser); analyser.connect(proc); proc.connect(audioCtx.destination);
            
            proc.onaudioprocess = () => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b)/data.length;
                
                // 嘴巴動作邏輯：利用臉部位移模擬說話
                if (vol > (105 - document.getElementById('sens').value)) {
                    head.style.transform = "scale(0.99) rotate(-0.5deg)"; 
                    mouth.style.transform = `translateY(${offsets.mouth_close + 1}px)`; 
                } else {
                    head.style.transform = ""; 
                    mouth.style.transform = `translateY(${offsets.mouth_close}px)`;
                }
            };

            // 自動眨眼
            const blink = () => {
                setV(eyes, true);
                setTimeout(() => setV(eyes, false), 150);
                setTimeout(blink, Math.random() * 4000 + 2000);
            };
            blink();

            document.getElementById('start-btn').innerText = "系統運行中...";
        } catch(e) { alert("啟動失敗，請確認已給予權限"); }
    };

    document.getElementById('hide-btn').onclick = () => document.getElementById('ui').classList.add('hidden');
    document.body.onclick = (e) => { if(e.target.tagName==='VIDEO') document.getElementById('ui').classList.toggle('hidden'); };
</script>
</body>
</html>
