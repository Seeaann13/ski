<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber Solo Pro V3.2</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; background: #000; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        /* V皮層 */
        .avatar-group {
            position: absolute; bottom: -5px; right: -10px;
            width: 45vw; height: auto; pointer-events: none; z-index: 10;
        }
        .part {
            position: absolute; bottom: 0; right: 0;
            width: 100%; height: auto;
            opacity: 0; visibility: hidden; /* 預設完全隱藏 */
            transition: transform 0.05s linear;
        }
        #base-body { z-index: 11; opacity: 1; visibility: visible; }
        #mouth-part { z-index: 12; } 
        #eyes-part { z-index: 13; }

        /* UI 面板 */
        #ui-layer {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: rgba(0, 0, 0, 0.85); padding: 15px; border-radius: 12px;
            color: white; display: flex; flex-direction: column; gap: 10px; width: 260px;
            backdrop-filter: blur(10px); border: 1px solid rgba(0, 210, 255, 0.3);
        }
        button { padding: 12px; background: #00d2ff; border: none; border-radius: 6px; color: #003344; font-weight: 800; cursor: pointer; }
        .adjust-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; background: rgba(255,255,255,0.05); padding: 5px 8px; border-radius: 5px; }
        .btn-sm { padding: 6px 12px; background: #444; color: white; border-radius: 4px; border: 1px solid #666; }
        select { padding: 8px; border-radius: 4px; background: #222; color: white; border: 1px solid #444; width: 100%; }
        .hint { font-size: 11px; color: #00d2ff; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="container">
    <video id="camera-video" autoplay playsinline muted></video>
    
    <div class="avatar-group">
        <img id="base-body" class="part" src="idle.png">
        <img id="mouth-part" class="part" src="mouth_open.png">
        <img id="eyes-part" class="part" src="eyes_closed.png">
    </div>
    
    <div id="ui-layer">
        <div style="text-align:center; font-weight:900; color:#00d2ff; letter-spacing: 1px;">SKI-VTUBER V3.2</div>
        
        <label class="hint">1. 選相機 (外接鏡頭通常在最後)</label>
        <select id="cam-select"></select>
        <button id="start-btn">啟動系統 (相機+麥克風)</button>
        
        <label class="hint">2. 位置微調</label>
        <div class="adjust-row">嘴巴: <div><button class="btn-sm" onclick="adjust('mouth', -2)">↑</button> <button class="btn-sm" onclick="adjust('mouth', 2)">↓</button></div></div>
        <div class="adjust-row">眼睛: <div><button class="btn-sm" onclick="adjust('eyes', -2)">↑</button> <button class="btn-sm" onclick="adjust('eyes', 2)">↓</button></div></div>

        <div style="font-size:12px; display: flex; justify-content: space-between;">
            靈敏度: <input type="range" id="sens-slider" min="0" max="100" value="45" style="width: 70%;">
        </div>
        
        <button id="hide-ui-btn" style="background:#cc3333; color:white; font-size:12px;">準備直播 (隱藏介面)</button>
    </div>
</div>

<script>
    const mouth = document.getElementById('mouth-part');
    const eyes = document.getElementById('eyes-part');
    const video = document.getElementById('camera-video');
    const camSelect = document.getElementById('cam-select');
    const sensSlider = document.getElementById('sens-slider');
    
    let isTalking = false, talkTimeout = null, currentStream = null;
    let offsets = { mouth: 0, eyes: 0 };

    // --- 零件顯示切換優化 ---
    function setPartVisible(el, isVisible) {
        if (isVisible) {
            el.style.opacity = "1";
            el.style.visibility = "visible";
        } else {
            el.style.opacity = "0";
            el.style.visibility = "hidden";
        }
    }

    function adjust(part, val) {
        offsets[part] += val;
        const target = (part === 'mouth') ? mouth : eyes;
        target.style.transform = `translateY(${offsets[part]}px)`;
    }

    // --- 相機偵測 ---
    async function initCameras() {
        try {
            await navigator.mediaDevices.getUserMedia({ video: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            camSelect.innerHTML = '';
            videoDevices.forEach((d, i) => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Camera ${i+1}`;
                if (d.label.toLowerCase().includes('usb') || i === videoDevices.length - 1) opt.selected = true;
                camSelect.appendChild(opt);
            });
        } catch (e) { console.error("Cam error"); }
    }

    // --- 核心啟動 ---
    document.getElementById('start-btn').onclick = async () => {
        try {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            currentStream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: { exact: camSelect.value } }
            });
            video.srcObject = currentStream;

            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaStreamSource(audioStream);
            const processor = audioCtx.createScriptProcessor(2048, 1, 1);
            
            analyser.fftSize = 1024;
            source.connect(analyser);
            analyser.connect(processor);
            processor.connect(audioCtx.destination);
            
            processor.onaudioprocess = () => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                const volume = data.reduce((a, b) => a + b) / data.length;
                const threshold = 105 - parseInt(sensSlider.value);
                
                if (volume > threshold) {
                    isTalking = true;
                    setPartVisible(mouth, true);
                    if (talkTimeout) clearTimeout(talkTimeout);
                    talkTimeout = setTimeout(() => {
                        isTalking = false;
                        setPartVisible(mouth, false);
                    }, 200);
                }
            };

            startAutoBlink(); // 啟動增強版眨眼
            document.getElementById('start-btn').innerText = "系統運作中";
            document.getElementById('start-btn').style.background = "#55ff55";
            document.getElementById('start-btn').style.color = "#000";
        } catch (err) { alert("啟動失敗: " + err.message); }
    };

    // --- 增強版自動眨眼 ---
    function startAutoBlink() {
        const minTime = 2000, maxTime = 6000;
        const blinkOne = () => {
            setPartVisible(eyes, true);
            setTimeout(() => {
                setPartVisible(eyes, false);
                const next = Math.floor(Math.random() * (maxTime - minTime)) + minTime;
                setTimeout(blinkOne, next);
            }, 180);
        };
        setTimeout(blinkOne, 2000);
    }

    initCameras();
    document.getElementById('container').onclick = (e) => {
        if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
            document.getElementById('ui-layer').classList.toggle('hidden');
        }
    };
    document.getElementById('hide-ui-btn').onclick = () => document.getElementById('ui-layer').classList.add('hidden');
</script>

</body>
</html>
