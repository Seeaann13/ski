<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber V9.2 Depth Pro</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: transparent; font-family: sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; }

        /* V皮總成 (呼吸律動) */
        #avatar-root {
            position: absolute; bottom: 0; right: 0; width: 45vw; height: auto;
            pointer-events: none;
            /* 讓身體、後領一起呼吸 */
            animation: breathe 3s ease-in-out infinite;
        }

        .layer { position: absolute; bottom: 0; left: 0; width: 100%; height: auto; transform-origin: top center; }

        /* --- 關鍵：前後層級 (Z-Index) --- */
        /* 數字越小越後面 */
        
        .z-0  { z-index: 5; }   /* 最底層 (如果有背景光環之類) */
        .z-10 { z-index: 10; }  /* 身體 (Body) */
        .z-15 { z-index: 15; }  /* ★ 關鍵：頭後面的外套/領子 (Jacket Back) */
        .z-20 { z-index: 20; }  /* 頭部主體 (Head) */
        .z-21 { z-index: 21; }  /* 五官 (Face Parts) */
        .z-30 { z-index: 30; }  /* 前髮 (Front Hair) */
        .z-40 { z-index: 40; }  /* 呆毛/最頂層 */

        /* --- 物理動態 --- */
        /* 頭部獨立擺動 (才不會跟身體黏死) */
        .head-sway { animation: head-move 4s ease-in-out infinite; transform-origin: center 80%; }
        
        /* 輕微的風 */
        .wind-light { animation: flutter 0.5s ease-in-out infinite alternate; }
        .wind-mid   { animation: sway 1.5s ease-in-out infinite alternate; }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.5s; }

        @keyframes breathe { 0%,100%{transform:scale(1)} 50%{transform:scale(1.015)} }
        @keyframes head-move { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(1.5deg)} }
        @keyframes flutter { 0%{transform:skewX(1deg)} 100%{transform:skewX(3deg)} }
        @keyframes sway    { 0%{transform:skewX(-1deg)} 100%{transform:skewX(2deg)} }

        #ui { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; z-index: 100; font-size: 12px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="container">
    <div id="avatar-root">
        
        <!-- [層級 1] 身體主體 -->
        <img id="body" class="layer z-10" src="body.png">

        <!-- [層級 2] ★ 關鍵：頭後面的外套/後領 (補在這裡！) -->
        <!-- 這張圖會蓋住身體，但在頭的後面 -->
        <img id="jacket_back" class="layer z-15" src="jacket_back.png">

        <!-- [層級 3] 頭部群組 (包含頭、五官、耳朵) -->
        <!-- 加上 head-sway 讓頭跟領子有相對運動 -->
        <div class="layer z-20 head-sway" style="width:100%; height:100%;">
            
            <img id="head" class="layer" src="head.png">
            <img id="ears" class="layer" src="ears.png" style="animation: flutter 2s infinite;">

            <!-- 表情 -->
            <img id="mouth_closed" class="layer z-21" src="mouth_closed.png">
            <img id="mouth_open"   class="layer z-21" src="mouth_open.png" style="opacity:0;">
            <img id="eyes_open"    class="layer z-21" src="eyes_open.png">
            <img id="eyes_closed"  class="layer z-21" src="eyes_closed.png" style="opacity:0;">

            <!-- [層級 4] 頭髮 (在臉的前面) -->
            <!-- 把你那十幾層頭髮放在這裡面 -->
            <img id="hair_1" class="layer z-30 wind-mid" src="hair_1.png">
            <img id="hair_2" class="layer z-30 wind-light delay-1" src="hair_2.png">
            <img id="hair_3" class="layer z-30 wind-mid delay-2" src="hair_3.png">
            <!-- 繼續加你的 hair_x.png ... -->

        </div>
    </div>

    <div id="ui">
        <b>V9.2 深度防穿模版</b><br>
        <button onclick="initAudio()">啟動同步</button>
        <button onclick="document.getElementById('ui').classList.add('hidden')" style="background:#f55;">隱藏</button>
    </div>
</div>

<script>
    const mouthClosed = document.getElementById('mouth_closed');
    const mouthOpen = document.getElementById('mouth_open');
    const eyesOpen = document.getElementById('eyes_open');
    const eyesClosed = document.getElementById('eyes_closed');
    let talkTimeout;

    function setTalking(isTalking) {
        mouthClosed.style.opacity = isTalking ? 0 : 1;
        mouthOpen.style.opacity = isTalking ? 1 : 0;
    }

    function blink() {
        eyesOpen.style.opacity = 0; eyesClosed.style.opacity = 1;
        setTimeout(() => {
            eyesOpen.style.opacity = 1; eyesClosed.style.opacity = 0;
            setTimeout(blink, Math.random() * 3000 + 2000);
        }, 150);
    }
    blink();

    async function initAudio() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioCtx = new AudioContext();
            const analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaStreamSource(stream);
            const script = audioCtx.createScriptProcessor(2048, 1, 1);
            source.connect(analyser); analyser.connect(script); script.connect(audioCtx.destination);
            script.onaudioprocess = () => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                if ((data.reduce((a,b)=>a+b)/data.length) > 20) {
                    setTalking(true); clearTimeout(talkTimeout);
                    talkTimeout = setTimeout(() => setTalking(false), 150);
                }
            };
            document.querySelector('button').innerText = "監聽中...";
        } catch(e) {}
    }
    document.body.ondblclick = () => document.getElementById('ui').classList.toggle('hidden');
</script>

</body>
</html>
