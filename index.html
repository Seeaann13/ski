<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Matcha Ski V14.1 Final Sandwich</title>
    
    <!-- å¼•å…¥ AI èªéŸ³åµæ¸¬æ ¸å¿ƒåº« -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web/dist/bundle.min.js"></script>

    <style>
        /* åŸºç¤å…¨è¢å¹•è¨­å®š */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #stage { position: relative; width: 100vw; height: 100vh; background: #000; }
        
        /* 1. åº•å±¤èƒŒæ™¯ (VDO.Ninja æ—¥æœ¬é›ªæ™¯) */
        /* ä½¿ç”¨ iframe åµŒå…¥ï¼Œz-index è¨­ç‚º 1ï¼Œå¼·åˆ¶é‹ªæ»¿ */
        iframe#ninja-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none; z-index: 1; pointer-events: none;
            object-fit: cover; background: #000;
        }
        
        /* 2. ä¸Šå±¤ Vçš® (Canvas ç•«å¸ƒ) */
        /* èƒŒæ™¯é€æ˜ï¼Œè®“åº•å±¤é€å‡ºä¾† */
        canvas#vtuber-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; background: transparent; 
        }

        /* 3. UI æ§åˆ¶é¢æ¿ */
        #ui {
            position: absolute; top: 15px; left: 15px; width: 280px; z-index: 100;
            background: rgba(10, 10, 20, 0.95); color: #00d2ff; padding: 18px; 
            border-radius: 20px; border: 1px solid rgba(0, 210, 255, 0.4);
            font-size: 13px; backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }
        .hidden { display: none !important; }

        /* é½’è¼ªæ•‘æ´æŒ‰éˆ• (æ°¸ä¹…é¡¯ç¤º) */
        #ui-toggle {
            position: absolute; bottom: 25px; left: 25px; z-index: 999;
            width: 44px; height: 44px; background: rgba(0, 210, 255, 0.2); 
            border: 2px solid #00d2ff; border-radius: 50%; color: #00d2ff; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 22px; cursor: pointer; backdrop-filter: blur(5px);
        }

        /* æ‹‰æ¡¿èˆ‡ä»‹é¢å…ƒç´  */
        label { display: block; margin-top: 10px; color: #888; font-size: 11px; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: #00d2ff; margin: 6px 0; cursor: pointer; }
        input[type=text] { width: 100%; background: #222; color: #fff; border: 1px solid #444; padding: 6px; border-radius: 5px; }
        
        #btn-start { 
            background: linear-gradient(135deg, #00d2ff, #0055ff); color: white; 
            border: none; padding: 14px; width: 100%; border-radius: 10px; 
            font-weight: 900; margin-top: 10px; cursor: pointer;
        }

        .meter-box { width: 100%; height: 6px; background: #222; border-radius: 3px; margin: 8px 0; overflow: hidden; position: relative; }
        #v-meter { height: 100%; width: 0%; background: #00ffcc; transition: width 0.05s; }
        .gate-line { position: absolute; top: 0; width: 2px; height: 100%; z-index: 2; }
        #gate-half { background: #ffff00; left: 0%; } 
        #gate-open { background: #ff0055; left: 0%; }
        #status-log { font-size: 10px; text-align: center; margin-top: 8px; color: #ffaa00; }
    </style>
</head>
<body>

<div id="stage">
    <!-- èƒŒæ™¯å±¤ï¼šVDO.Ninja æ—¥æœ¬å½±åƒ -->
    <iframe id="ninja-bg" src="about:blank" allow="autoplay; microphone; camera;"></iframe>
    
    <!-- å‰æ™¯å±¤ï¼šä½ çš„ V çš® -->
    <canvas id="vtuber-canvas"></canvas>

    <!-- ä»‹é¢é–‹é—œ -->
    <div id="ui-toggle">âš™ï¸</div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="ui">
        <div style="text-align:center; font-weight:900; font-size:16px; color:#fff; margin-bottom:5px;">V14.1 çœŸÂ·ä¸‰æ˜æ²»èƒŒæ™¯ç‰ˆ</div>
        
        <label>1. æ—¥æœ¬ ID (sean1357):</label>
        <input type="text" id="stream-id" value="sean1357">

        <label>2. èªéŸ³è¨Šè™Ÿ (AIåˆ†æä¸­):</label>
        <div class="meter-box">
            <div id="v-meter"></div>
            <div id="gate-half" class="gate-line"></div>
            <div id="gate-open" class="gate-line"></div>
        </div>
        <input type="range" id="p-sens" min="0" max="100" value="70">
        
        <label>3. ç‰©ç†è¨­å®š (ä½ç½®Y / ç¸®æ”¾):</label>
        <input type="range" id="p-y" min="-600" max="1200" value="850">
        <input type="range" id="p-scale" min="0.2" max="2.0" step="0.01" value="0.95">
        <input type="hidden" id="p-x" value="0"> <!-- X é è¨­å±…ä¸­ -->
        
        <label>4. ç’°å¢ƒé¢¨åŠ›:</label>
        <input type="range" id="p-wind" min="0" max="10" step="0.1" value="3.0">

        <button id="btn-start">ğŸš€ å•Ÿå‹•é€£ç·šç³»çµ±</button>
        <div id="status-log">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸èˆ‡ DOM ç¶å®š ---
    const ninjaFrame = document.getElementById('ninja-bg');
    const ui = document.getElementById('ui');
    const toggle = document.getElementById('ui-toggle');
    const canvas = document.getElementById('vtuber-canvas');
    const ctx = canvas.getContext('2d');
    const layers = [];
    let globalTime = 0;
    let talkTimer = null;

    // ä»‹é¢é–‹é—œ
    toggle.onclick = () => ui.classList.toggle('hidden');

    // --- 1. ç‰©ç†å¼•æ“é¡åˆ¥ (è™•ç† 2000px å¤§åœ–èˆ‡å½ˆç°§ç‰©ç†) ---
    class PhysicsLayer {
        constructor(name, img, type, z) {
            this.name = name; this.img = img; this.type = type; this.z = z;
            this.angle = 0; this.vel = 0; this.visible = true; this.id = name.split('.')[0];
            
            // ç‰©ç†æè³ª
            this.mass = 1.0; this.stiffness = 0.08; this.damping = 0.9;
            
            // è‡ªå‹•è³¦äºˆæè³ªå±¬æ€§
            if (name.includes('_L')) { this.mass = 0.6; this.stiffness = 0.15; } // è¼•é«®
            if (name.includes('_H')) { this.mass = 2.5; this.stiffness = 0.05; } // é‡é«®
            if (name.includes('front')) { this.mass = 0.8; this.stiffness = 0.12; }
        }

        update(wind, headSway) {
            // éœæ…‹ç‰©é«”ä¸å‹•
            if (this.type === 'static') return;
            
            // é ­éƒ¨èˆ‡äº”å®˜ï¼šç›´æ¥é–å®šè§’åº¦ (é˜²æŠ–)
            if (this.type === 'head' || this.type === 'face') {
                this.angle = headSway; return;
            }

            // é ­é«®ç‰©ç†ï¼šé¢¨åŠ› + æ…£æ€§
            let target = (wind * (2 - this.mass*0.3)) + (headSway * this.mass * 0.5);
            // å½ˆç°§å…¬å¼
            this.vel = (this.vel + (target - this.angle) * this.stiffness) * this.damping;
            this.angle += this.vel;
        }
    }

    // --- 2. æª”æ¡ˆæ¸…å–® (ä¸‰æ˜æ²»çµæ§‹ï¼šå¾Œé ˜ < é ­ < èº«é«”) ---
    const fileList = [
        {n:'jacket_back.png', t:'static', z:10},
        {n:'head.png',        t:'head',   z:15},
        {n:'body.png',        t:'static', z:20},
        {n:'ears.png',        t:'head',   z:25},
        {n:'mouth_close.png', t:'face',   z:26, id:'m_close'},
        {n:'mouth_half.png',  t:'face',   z:26, id:'m_half', v:false},
        {n:'mouth_open.png',  t:'face',   z:26, id:'m_open', v:false},
        {n:'eyes_open.png',   t:'face',   z:27, id:'e_open'},
        {n:'eyes_closed.png', t:'face',   z:27, id:'e_closed', v:false},
        {n:'hair_base.png',   t:'hair',   z:30},
        {n:'hair_H1.png',     t:'hair',   z:31}, {n:'hair_H2.png', t:'hair', z:31},
        {n:'hair_M1.png',     t:'hair',   z:32}, {n:'hair_M2.png', t:'hair', z:32},
        {n:'hair_L1.png',     t:'hair',   z:33},
        {n:'layer-front1.png',t:'hair',   z:40}, {n:'layer-front2.png',t:'hair',   z:40}
    ];

    // --- 3. è³‡æºè¼‰å…¥å™¨ ---
    async function loadResources() {
        const status = document.getElementById('status-log');
        let count = 0;
        for (let f of fileList) {
            await new Promise(r => {
                const img = new Image(); 
                img.src = f.n + "?t=" + Date.now(); // é˜²å¿«å–
                img.onload = () => {
                    const l = new PhysicsLayer(f.n, img, f.t, f.z);
                    if (f.id) l.id = f.id; if (f.v !== undefined) l.visible = f.v;
                    layers.push(l);
                    count++;
                    status.innerText = `è¼‰å…¥ V çš®: ${Math.round(count/fileList.length*100)}%`;
                    r();
                };
                img.onerror = () => { console.warn("ç¼ºåœ–è·³é: "+f.n); r(); };
            });
        }
        layers.sort((a,b) => a.z - b.z);
        status.innerText = "è³‡æºå°±ç·’";
    }

    // --- 4. ç¹ªåœ–è¿´åœˆ (å«èƒŒæ™¯é€è¦–) ---
    function draw() {
        // è¨­å®šé«˜ç•«è³ª
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        const w = window.innerWidth; const h = window.innerHeight;
        
        // â˜… é—œéµï¼šæ¯æ¬¡æ¸…ç©ºç•«å¸ƒï¼Œè®“åº•å±¤ iframe é›ªæ™¯é€å‡ºä¾†
        ctx.clearRect(0,0,w,h);

        globalTime += 0.05;
        // è‡ªç„¶é¢¨å ´ (åŸºç¤é¢¨ + éš¨æ©Ÿäº‚æµ)
        const wind = (parseFloat(document.getElementById('p-wind').value) * 0.02) + (Math.sin(globalTime*0.7)*0.01);
        const headSway = Math.sin(globalTime * 0.5) * 0.03; // å‘¼å¸æ“ºå‹•

        const scale = parseFloat(document.getElementById('p-scale').value);
        const offX = parseFloat(document.getElementById('p-x').value);
        const offY = parseFloat(document.getElementById('p-y').value); // é€™è£¡é è¨­ 850ï¼ŒæŠŠäººå¾€ä¸‹æ‹‰

        layers.forEach(l => {
            if (!l.visible) return;
            l.update(wind, headSway);

            ctx.save();
            // å®šä½ï¼šè¢å¹•ä¸­å¿ƒ + åç§»é‡
            ctx.translate(w/2 + offX, h/2 + offY);
            ctx.scale(scale, scale);

            // â˜… éŒ¨é»ä¿®æ­£ï¼šé‡å° 2000px å¤§åœ–ï¼Œå°‡æ—‹è½‰é»å®šåœ¨é ­éƒ¨ (ç´„ 70% é«˜åº¦)
            const pivotY = -l.img.height * 0.7; 
            
            if (l.type !== 'static') {
                ctx.translate(0, pivotY); 
                // ä½¿ç”¨ Skew ç‰©ç† (é˜²æ­¢é ­é«®é£›èµ·ä¾†)
                ctx.transform(1, 0, l.angle, 1, 0, 0); 
                ctx.translate(0, -pivotY);
            }

            // ç¹ªè£½åœ–ç‰‡ (å±…ä¸­å°é½Šåº•éƒ¨)
            ctx.drawImage(l.img, -l.img.width/2, -l.img.height);
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    // --- 5. è¡¨æƒ…èˆ‡ AI ---
    function setMouthState(state) {
        const mClose = layers.find(l=>l.id==='m_close');
        const mHalf  = layers.find(l=>l.id==='m_half');
        const mOpen  = layers.find(l=>l.id==='m_open');
        // é˜²å‘†ï¼šç¼ºåœ–è‡ªå‹•å‡ç´š
        if (!mHalf && state === 1) state = 2;
        if (mClose) mClose.visible = (state === 0);
        if (mHalf)  mHalf.visible  = (state === 1);
        if (mOpen)  mOpen.visible  = (state === 2);
    }

    function setEyes(isOpen) {
        const eOpen = layers.find(l=>l.id==='e_open');
        const eClosed = layers.find(l=>l.id==='e_closed');
        if(eOpen && eClosed){ eOpen.visible=isOpen; eClosed.visible=!isOpen; }
    }

    // AI å•Ÿå‹•é‚è¼¯
    async function startAudio() {
        try {
            document.getElementById('status-log').innerText = "AI åŠ è¼‰ä¸­...";
            const myVAD = await vad.MicVAD.new({
                onFrameProcessed: (probs) => {
                    // è¨ˆç®—é–€æª»
                    const sensVal = document.getElementById('p-sens').value;
                    const baseThreshold = 1.0 - (sensVal / 100);
                    const halfThreshold = baseThreshold; 
                    const openThreshold = baseThreshold + 0.25;

                    // UI æ›´æ–°
                    document.getElementById('v-meter').style.width = (probs.isSpeech*100)+"%";
                    document.getElementById('gate-half').style.left = (halfThreshold*100)+"%";
                    document.getElementById('gate-open').style.left = (Math.min(openThreshold, 1.0)*100)+"%";

                    // ä¸‰æ®µè§¸ç™¼
                    if (probs.isSpeech > openThreshold) {
                        setMouthState(2); resetTalkTimer();
                    } else if (probs.isSpeech > halfThreshold) {
                        setMouthState(1); resetTalkTimer();
                    }
                }
            });
            myVAD.start();
            document.getElementById('status-log').innerText = "AI é‹ä½œä¸­ (æœ€ä½³)";
        } catch (e) {
            console.warn("AI å¤±æ•—ï¼Œåˆ‡æ›å‚™æ´é »ç‡æ¨¡å¼");
            startFallbackFFT();
        }
    }

    // å‚™æ´æ¨¡å¼
    async function startFallbackFFT() {
        document.getElementById('status-log').innerText = "å‚™æ´æ¨¡å¼ (é »ç‡)";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const ana = ctx.createAnalyser();
            const src = ctx.createMediaStreamSource(stream);
            const script = ctx.createScriptProcessor(2048, 1, 1);
            src.connect(ana); ana.connect(script); script.connect(ctx.destination);
            script.onaudioprocess = () => {
                const data = new Uint8Array(ana.frequencyBinCount); ana.getByteFrequencyData(data);
                let e = 0; for(let i=5;i<60;i++) e+=data[i];
                const vol = e/55; 
                document.getElementById('v-meter').style.width = Math.min(vol*2, 100)+"%";
                const sens = 105 - document.getElementById('p-sens').value;
                if (vol > sens) { setMouthState(2); resetTalkTimer(); }
            };
        } catch(e) { alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™"); }
    }

    function resetTalkTimer() {
        if (talkTimer) clearTimeout(talkTimer);
        talkTimer = setTimeout(() => {
            setMouthState(1);
            setTimeout(() => setMouthState(0), 100);
        }, 150);
    }

    function autoBlink() {
        setEyes(false);
        setTimeout(() => { setEyes(true); setTimeout(autoBlink, Math.random()*3000+2000); }, 150);
    }

    // --- 6. ç³»çµ±å…¥å£ ---
    document.getElementById('btn-start').onclick = async () => {
        const btn = document.getElementById('btn-start');
        btn.innerText = "è¼‰å…¥èƒŒæ™¯..."; btn.disabled = true;
        
        // A. è¼‰å…¥æ—¥æœ¬é›ªæ™¯ (åŠ å…¥ playsinline åƒæ•¸é˜²æ­¢å½ˆå‡º)
        const sID = document.getElementById('stream-id').value; 
        ninjaFrame.src = `https://vdo.ninja/?view=${sID}&room=sss&solo&autoplay=1&cleanoutput=1&transparent=0&playsinline=1&cover=1`;

        // B. è¼‰å…¥ V çš®
        await loadResources();
        
        // C. å•Ÿå‹•è½è¦º
        await startAudio();
        
        // D. å•Ÿå‹•è¦–è¦º
        setInterval(() => { setEyes(false); setTimeout(()=>setEyes(true), 150); }, Math.random()*3000+2000);
        draw();
        
        btn.innerText = "ç³»çµ±é‹ä½œä¸­"; btn.style.background = "#55ff55";
        
        // è‡ªå‹•éš±è—ä»‹é¢
        setTimeout(() => ui.classList.add('hidden'), 3000);
    };

    // åˆå§‹åŒ–ç•«å¸ƒ
    function setup() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        canvas.style.width = window.innerWidth+'px'; canvas.style.height = window.innerHeight+'px';
        ctx.scale(dpr, dpr);
    }
    window.onload = setup; window.onresize = setup;

</script>
</body>
</html>
