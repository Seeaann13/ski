<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Matcha Ski V13.7 Pro Center-Sync</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web/dist/bundle.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #stage { position: relative; width: 100vw; height: 100vh; background: #000; display: flex; justify-content: center; align-items: center; }
        
        /* èƒŒæ™¯ Ninja ä¸²æµ */
        iframe#ninja-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none; z-index: 1; pointer-events: none;
            object-fit: cover;
        }
        
        /* Vçš®ç•«å¸ƒ */
        canvas#vtuber-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        /* UI è¨­å®šé¢æ¿ */
        #ui {
            position: absolute; top: 15px; left: 15px; width: 280px; z-index: 100;
            background: rgba(10, 10, 15, 0.9); color: #00d2ff; padding: 18px; 
            border-radius: 20px; border: 1px solid rgba(0, 210, 255, 0.4);
            font-size: 12px; backdrop-filter: blur(15px);
        }
        .hidden { display: none !important; }
        #ui-toggle {
            position: absolute; bottom: 25px; left: 25px; z-index: 999;
            width: 44px; height: 44px; background: rgba(0, 210, 255, 0.2); 
            border: 2px solid #00d2ff; border-radius: 50%; color: #00d2ff; 
            display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer;
        }

        label { display: block; margin-top: 8px; color: #888; font-size: 10px; font-weight: bold; }
        input[type=range], select { width: 100%; accent-color: #00d2ff; margin: 4px 0; background: #222; color: #fff; border: 1px solid #444; padding: 4px; border-radius: 4px; }
        
        #btn-start { 
            background: linear-gradient(135deg, #00d2ff, #0055ff); color: white; 
            border: none; padding: 12px; width: 100%; border-radius: 10px; 
            font-weight: 900; margin-top: 10px; cursor: pointer;
        }
        .meter-box { width: 100%; height: 6px; background: #222; border-radius: 3px; margin: 5px 0; overflow: hidden; position: relative; }
        #v-meter { height: 100%; width: 0%; background: #00ffcc; transition: width 0.05s; }
        #status-log { font-size: 10px; text-align: center; margin-top: 8px; color: #ffaa00; }
    </style>
</head>
<body>

<div id="stage">
    <iframe id="ninja-bg" allow="autoplay; microphone;"></iframe>
    <canvas id="vtuber-canvas"></canvas>
    <div id="ui-toggle">âš™ï¸</div>

    <div id="ui">
        <div style="text-align:center; font-weight:900; font-size:15px; margin-bottom:5px;">V13.7 1:1 å°ä½ç‰ˆ</div>
        
        <label>1. æ»‘é›ªå ´ ID:</label>
        <input type="text" id="stream-id" value="sean1357">

        <label>2. é¸æ“‡éŸ³è¨Šè¼¸å…¥ (å°ç£ç«¯è«‹é¸ç³»çµ±è²éŸ³):</label>
        <select id="audio-source"><option>ç­‰å¾…å•Ÿå‹•...</option></select>

        <label>3. è²éŸ³åæ‡‰åº¦:</label>
        <div class="meter-box"><div id="v-meter"></div></div>
        <input type="range" id="p-sens" min="0" max="100" value="70">
        
        <label>4. ç‰©ç†é¢¨åŠ› / äººç‰©ç¸®æ”¾:</label>
        <input type="range" id="p-wind" min="0" max="10" step="0.1" value="2.5">
        <input type="range" id="p-scale" min="0.1" max="1.5" step="0.01" value="0.7">

        <label>5. ä½ç½®å¾®èª¿ (X / Y):</label>
        <div style="display:flex; gap:5px;">
            <input type="range" id="p-x" min="-1000" max="1000" value="0">
            <input type="range" id="p-y" min="-1000" max="1000" value="0">
        </div>

        <button id="btn-start">ğŸš€ å•Ÿå‹•åˆæˆ</button>
        <div id="status-log">å°±ç·’</div>
    </div>
</div>

<script>
    const ninjaFrame = document.getElementById('ninja-bg');
    const ui = document.getElementById('ui');
    const toggle = document.getElementById('ui-toggle');
    const audioSelect = document.getElementById('audio-source');
    toggle.onclick = () => ui.classList.toggle('hidden');

    class PhysicsLayer {
        constructor(name, img, type, z) {
            this.name = name; this.img = img; this.type = type; this.z = z;
            this.angle = 0; this.vel = 0; this.visible = true; this.id = name.split('.')[0];
            this.mass = 1.0; this.stiffness = 0.08; this.damping = 0.9;
            if (name.includes('_L')) { this.mass = 0.6; this.stiffness = 0.15; }
            if (name.includes('_H')) { this.mass = 3.0; this.stiffness = 0.05; }
        }
        update(wind, headSway) {
            if (this.type === 'static' || this.type === 'head' || this.type === 'face') { this.angle = headSway; return; }
            let target = (wind * (2 - this.mass*0.3)) + (headSway * this.mass * 0.5);
            this.vel = (this.vel + (target - this.angle) * this.stiffness) * this.damping;
            this.angle += this.vel;
        }
    }

    const canvas = document.getElementById('vtuber-canvas');
    const ctx = canvas.getContext('2d');
    const layers = [];
    let globalTime = 0;

    const fileList = [
        {n:'jacket_back.png', t:'static', z:10},
        {n:'head.png',        t:'head',   z:15},
        {n:'body.png',        t:'static', z:20},
        {n:'ears.png',        t:'head',   z:25},
        {n:'mouth_close.png', t:'face',   z:26, id:'m_close'},
        {n:'mouth_half.png',  t:'face',   z:26, id:'m_half', v:false},
        {n:'mouth_open.png',  t:'face',   z:26, id:'m_open', v:false},
        {n:'eyes_open.png',   t:'face',   z:27, id:'e_open'},
        {n:'eyes_closed.png', t:'face',   z:27, id:'e_closed', v:false},
        {n:'hair_base.png',   t:'hair',   z:30},
        {n:'hair_H1.png',     t:'hair',   z:31}, {n:'hair_H2.png', t:'hair', z:31},
        {n:'hair_M1.png',     t:'hair',   z:32}, {n:'hair_M2.png', t:'hair', z:32},
        {n:'hair_L1.png',     t:'hair',   z:33},
        {n:'layer-front1.png',t:'hair',   z:40}, {n:'layer-front2.png',t:'hair',   z:40}
    ];

    async function loadResources() {
        for (let f of fileList) {
            const img = new Image(); img.src = f.n + "?t=" + Date.now();
            await new Promise(r => { img.onload = () => {
                const l = new PhysicsLayer(f.n, img, f.t, f.z);
                if (f.id) l.id = f.id; if (f.v !== undefined) l.visible = f.v;
                layers.push(l); r();
            }; img.onerror = r; });
        }
        layers.sort((a,b) => a.z - b.z);
    }

    function draw() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        const w = window.innerWidth; const h = window.innerHeight;
        ctx.clearRect(0,0, w, h);

        globalTime += 0.05;
        const wind = (parseFloat(document.getElementById('p-wind').value) * 0.02) + (Math.sin(globalTime*0.7)*0.01);
        const headSway = Math.sin(globalTime * 0.5) * 0.03;
        const scale = parseFloat(document.getElementById('p-scale').value);
        const offX = parseFloat(document.getElementById('p-x').value);
        const offY = parseFloat(document.getElementById('p-y').value);

        layers.forEach(l => {
            if (!l.visible) return;
            l.update(wind, headSway);
            ctx.save();
            
            // â˜… ä¿®å¾©æ ¸å¿ƒï¼šä¸­å¿ƒé» 1:1 ç–ŠåŠ  â˜…
            // æ—¢ç„¶åœ–æ˜¯ 2000x2000ï¼Œæˆ‘å€‘å°‡åŸé»ç§»åˆ°è¢å¹•ä¸­å¿ƒï¼Œç›´æ¥ç¹ªè£½
            ctx.translate(w/2 + offX, h/2 + offY);
            ctx.scale(scale, scale);

            // ä»¥ç•«å¸ƒä¸­å¿ƒ (1000, 1000) ä½œç‚ºæ—‹è½‰æ”¯é»
            // é€™å° 2000x2000 çš„å…¨ç•«å¸ƒè¼¸å‡ºæœ€ç²¾æº–
            if (l.type !== 'static') {
                ctx.translate(0, -200); // é€™è£¡å¾®èª¿æ—‹è½‰é»è‡³å¤§ç´„è„–å­é«˜åº¦
                ctx.transform(1, 0, l.angle, 1, 0, 0); 
                ctx.translate(0, 200);
            }

            // ç•«åœ–ï¼šåº§æ¨™ (-1000, -1000) è®“ 2000x2000 çš„ä¸­å¿ƒé»å°é½Š (0,0)
            ctx.drawImage(l.img, -1000, -1000, 2000, 2000);
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    function setMouthState(state) {
        const mClose = layers.find(l=>l.id==='m_close');
        const mHalf  = layers.find(l=>l.id==='m_half');
        const mOpen  = layers.find(l=>l.id==='m_open');
        if (mClose) mClose.visible = (state === 0);
        if (mHalf)  mHalf.visible  = (state === 1);
        if (mOpen)  mOpen.visible  = (state === 2);
    }

    async function startAudio() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { deviceId: { exact: audioSelect.value } } 
            });
            const myVAD = await vad.MicVAD.new({
                stream: stream,
                onFrameProcessed: (probs) => {
                    const sens = document.getElementById('p-sens').value;
                    const baseT = 1.0 - (sens / 100);
                    document.getElementById('v-meter').style.width = (probs.isSpeech*100)+"%";
                    if (probs.isSpeech > baseT + 0.25) { setMouthState(2); resetTalkTimer(); }
                    else if (probs.isSpeech > baseT) { setMouthState(1); resetTalkTimer(); }
                }
            });
            myVAD.start();
        } catch (e) { alert("éŸ³è¨Šå•Ÿå‹•å¤±æ•—: " + e.message); }
    }

    let talkTimer = null;
    function resetTalkTimer() {
        if (talkTimer) clearTimeout(talkTimer);
        talkTimer = setTimeout(() => { setMouthState(1); setTimeout(() => setMouthState(0), 100); }, 150);
    }

    async function initAudioDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audios = devices.filter(d => d.kind === 'audioinput');
        audioSelect.innerHTML = audios.map(a => `<option value="${a.deviceId}">${a.label || 'Audio Source'}</option>`).join('');
    }

    document.getElementById('btn-start').onclick = async () => {
        const btn = document.getElementById('btn-start');
        btn.innerText = "è¼‰å…¥ä¸­..."; btn.disabled = true;
        
        const sID = document.getElementById('stream-id').value; 
        ninjaFrame.src = `https://vdo.ninja/?view=${sID}&room=sss&solo&autoplay=1&cleanoutput=1&transparent=0&playsinline=1&cover=1`;

        await loadResources();
        await startAudio();
        
        setInterval(() => {
            const eO = layers.find(l=>l.id==='e_open'); const eC = layers.find(l=>l.id==='e_closed');
            if(eO&&eC){ eO.visible=false; eC.visible=true; setTimeout(()=>{eO.visible=true; eC.visible=false;},150); }
        }, Math.random()*3000+2000);
        
        draw();
        btn.innerText = "ç³»çµ±é‹ä½œä¸­"; btn.style.background = "#55ff55";
        setTimeout(() => ui.classList.add('hidden'), 5000);
    };

    window.onload = async () => {
        await initAudioDevices();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
    };
</script>
</body>
</html>
