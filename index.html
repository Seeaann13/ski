<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matcha Ski V14.0 OBS Master</title>
    
    <!-- å¼•å…¥ AI èˆ‡ VDO.Ninja API -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web/dist/bundle.min.js"></script>
    <script src="https://vdo.ninja/iframeapi.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* éš±å½¢çš„ Ninja é€šé“ */
        #ninja-holder { position: absolute; top: -1000px; width: 1px; height: 1px; opacity: 0; }

        #ui {
            position: absolute; top: 15px; left: 15px; width: 280px; z-index: 100;
            background: rgba(10, 10, 20, 0.9); color: #00d2ff; padding: 20px; 
            border-radius: 16px; border: 1px solid rgba(0, 210, 255, 0.4);
            font-size: 13px; backdrop-filter: blur(15px);
        }
        label { display: block; margin-top: 10px; color: #888; font-size: 11px; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: #00d2ff; margin: 5px 0; }
        .hidden { display: none !important; }
        button { background: #00d2ff; color: #000; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: 900; margin-top: 10px; cursor: pointer; }
        #status-log { font-size: 11px; text-align: center; margin-top: 10px; color: #ffaa00; }
    </style>
</head>
<body>

<div id="ninja-holder"></div>
<canvas id="vtuber-canvas"></canvas>

<div id="ui">
    <div style="text-align:center; font-weight:900; font-size:16px; color:#fff;">V14.0 å½±å­å°æ’­ç³»çµ±</div>
    
    <label>1. æ»‘é›ªå ´ ID (Japan ID):</label>
    <input type="text" id="stream-id" value="sean1357" style="width:100%; background:#222; color:#fff; border:1px solid #444; padding:8px; border-radius:5px;">

    <label>2. äººç‰©ä½ç½® Y (æ‹‰å¤§æ•¸å€¼å¾€ä¸‹å£“):</label>
    <input type="range" id="p-y" min="-500" max="1500" value="850">
    
    <label>3. äººç‰©ä½ç½® X / ç¸®æ”¾:</label>
    <input type="range" id="p-x" min="-500" max="500" value="0">
    <input type="range" id="p-scale" min="0.2" max="2.0" step="0.01" value="0.95">

    <label>4. ç‰©ç†é¢¨åŠ›:</label>
    <input type="range" id="p-wind" min="0" max="10" step="0.1" value="3.0">

    <button id="btn-start">ğŸš€ å•Ÿå‹•é€£ç·š (OBS å°ˆç”¨)</button>
    <div id="status-log">ç­‰å¾…æŒ‡ä»¤...</div>
    <button onclick="document.getElementById('ui').classList.add('hidden')" style="background:transparent; color:#555; font-size:10px;">éš±è—ä»‹é¢</button>
</div>

<script>
    // --- æ¨¡çµ„ 1: è³‡æºèˆ‡ç‰©ç†æ ¸å¿ƒ ---
    const canvas = document.getElementById('vtuber-canvas');
    const ctx = canvas.getContext('2d');
    const layers = [];
    let globalTime = 0;
    
    class PhysicsLayer {
        constructor(name, img, type, z) {
            this.name = name; this.img = img; this.type = type; this.z = z;
            this.angle = 0; this.vel = 0; this.visible = true;
            this.id = name.split('.')[0];
            this.mass = name.includes('_H') ? 3.0 : (name.includes('_L') ? 0.6 : 1.0);
            this.stiffness = name.includes('_H') ? 0.04 : 0.1;
            this.damping = 0.9;
        }
        update(wind, headSway) {
            if (this.type === 'static' || this.type === 'head' || this.type === 'face') { this.angle = headSway; return; }
            let target = (wind * (2 - this.mass*0.3)) + (headSway * this.mass * 0.5);
            this.vel = (this.vel + (target - this.angle) * this.stiffness) * this.damping;
            this.angle += this.vel;
        }
    }

    const fileList = [
        {n:'jacket_back.png', t:'static', z:10},
        {n:'head.png',        t:'head',   z:15},
        {n:'body.png',        t:'static', z:20},
        {n:'ears.png',        t:'head',   z:25},
        {n:'mouth_close.png', t:'face',   z:26, id:'m_close'},
        {n:'mouth_half.png',  t:'face',   z:26, id:'m_half', v:false},
        {n:'mouth_open.png',  t:'face',   z:26, id:'m_open', v:false},
        {n:'eyes_open.png',   t:'face',   z:27, id:'e_open'},
        {n:'eyes_closed.png', t:'face',   z:27, id:'e_closed', v:false},
        {n:'hair_base.png',   t:'hair',   z:30},
        {n:'hair_H1.png',     t:'hair',   z:31}, {n:'hair_H2.png', t:'hair', z:31},
        {n:'hair_M1.png',     t:'hair',   z:32}, {n:'hair_M2.png', t:'hair', z:32},
        {n:'hair_L1.png',     t:'hair',   z:33},
        {n:'layer-front1.png',t:'hair',   z:40}, {n:'layer-front2.png',t:'hair',   z:40}
    ];
// --- [æ¨¡çµ„ 1 çµæŸ] ---
    // --- æ¨¡çµ„ 2: è³‡æºè¼‰å…¥èˆ‡ VDO.Ninja æ©‹æ¥å™¨ ---
    let bgVideo = null; // å­˜æ”¾ä¾†è‡ªæ—¥æœ¬çš„å½±åƒæµ
    let ninjaAPI = null;

    // 1. è³‡æºè¼‰å…¥ (æ”¯æ´ 16 å±¤åœ–å±¤)
    async function loadResources() {
        const log = document.getElementById('status-log');
        let loaded = 0;
        for (let f of fileList) {
            const img = new Image();
            // åŠ å…¥éš¨æ©Ÿåƒæ•¸é˜²æ­¢èˆŠåœ–å¿«å–
            img.src = f.n + "?t=" + Date.now();
            await new Promise(r => {
                img.onload = () => {
                    const l = new PhysicsLayer(f.n, img, f.t, f.z);
                    if (f.id) l.id = f.id;
                    if (f.v !== undefined) l.visible = f.v;
                    layers.push(l);
                    loaded++;
                    log.innerText = `è¼‰å…¥ V çš®è³‡æº: ${Math.round(loaded/fileList.length*100)}%`;
                    r();
                };
                img.onerror = () => { console.warn("æ‰¾ä¸åˆ°æª”æ¡ˆ:", f.n); r(); };
            });
        }
        layers.sort((a,b) => a.z - b.z);
        log.innerText = "V çš®è¼‰å…¥å®Œæˆï¼Œç­‰å¾…è¨Šè™Ÿ...";
    }

    // 2. VDO.Ninja è¨Šè™Ÿæ©‹æ¥é‚è¼¯
    function setupNinjaLink(streamID) {
        const log = document.getElementById('status-log');
        const holder = document.getElementById('ninja-holder');
        
        // å»ºç«‹éš±å½¢çš„å‚³è¼¸è¦–çª— (åŠ å…¥ room=sss èˆ‡ solo åƒæ•¸)
        const url = `https://vdo.ninja/?view=${streamID}&room=sss&autoplay=1&cleanoutput=1&transparent=1&playsinline=1&cover=1&hidden=1`;
        holder.innerHTML = `<iframe id="ninja-iframe" src="${url}" allow="autoplay;microphone;camera;"></iframe>`;

        const iframe = document.getElementById('ninja-iframe');
        
        // ä½¿ç”¨å®˜æ–¹ API ç›£æ§
        iframe.onload = () => {
            log.innerText = "å·²é€£ç·šé›²ç«¯ï¼Œæ­£åœ¨æœå°‹æ—¥æœ¬è¨Šè™Ÿ...";
            // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨æœ€ç©©å®šçš„æ–¹å¼ï¼šå¦‚æœåµæ¸¬åˆ° iframe å…§æœ‰è²éŸ³ï¼Œä»£è¡¨è¨Šè™Ÿåˆ°äº†
            // ç”±æ–¼è·¨ç¶²åŸŸé™åˆ¶ï¼Œæˆ‘å€‘ä¸»è¦ä¾è³´ä¸‹ä¸€éƒ¨åˆ†çš„ AI åˆ†æä¾†ç¢ºèª
        };
    }

    // 3. ç¹ªåœ–ä¸»å¾ªç’° (åŒ…å«èƒŒæ™¯å½±ç‰‡ç¹ªè£½)
    function draw() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        
        const w = window.innerWidth;
        const h = window.innerHeight;
        ctx.clearRect(0, 0, w, h);

        // --- A. ç•«èƒŒæ™¯ (æ»‘é›ªé¢¨æ™¯) ---
        // æˆ‘å€‘ç›´æ¥æŠ“å– iframe å…§çš„å½±ç‰‡ï¼ˆå¦‚æœæœ‰æ¬Šé™ï¼‰æˆ–ä½¿ç”¨ MediaSource
        // å¦‚æœæ˜¯ OBSï¼Œæˆ‘å€‘é€šå¸¸è®“èƒŒæ™¯ä¿æŒé€æ˜æˆ–è®€å– stream
        // ç‚ºäº†æœ€ç©©ï¼Œæˆ‘å€‘å°‡åœ¨ä¸‹ä¸€æ¨¡çµ„åŠ å…¥ Video ç‰©ä»¶æ•ç²

        // --- B. æ›´æ–°ç‰©ç†èˆ‡ç¹ªè£½ V çš® ---
        globalTime += 0.05;
        const pWind = parseFloat(document.getElementById('p-wind').value);
        const wind = (pWind * 0.02) + (Math.sin(globalTime * 0.7) * 0.01);
        const headSway = Math.sin(globalTime * 0.5) * 0.03;

        const scale = parseFloat(document.getElementById('p-scale').value);
        const offX = parseFloat(document.getElementById('p-x').value);
        const offY = parseFloat(document.getElementById('p-y').value);

        layers.forEach(l => {
            if (!l.visible) return;
            l.update(wind, headSway);

            ctx.save();
            // â˜… æ ¸å¿ƒä¿®å¾©ï¼š2000px ä¸­å¿ƒåç§»é‚è¼¯ â˜…
            // æ—¢ç„¶åœ–ç‰‡å¾ˆå¤§ï¼Œæˆ‘å€‘ä»¥ w/2 å’Œ h ç‚ºåŸºæº–ï¼Œå†å¾€ä¸‹æ¨ offY
            ctx.translate(w / 2 + offX, h + offY);
            ctx.scale(scale, scale);

            // è¨­å®šæ—‹è½‰ä¸­å¿ƒåœ¨åœ–ç‰‡ä¸Šæ–¹çš„ 30% è™• (ç´„é ­éƒ¨ä½ç½®)
            const pivotY = -l.img.height * 0.75; 
            if (l.type !== 'static') {
                ctx.translate(0, pivotY);
                // ä½¿ç”¨ Skew ç‰©ç†è®“é ­é«®ä¸æœƒç”©é£›
                ctx.transform(1, 0, l.angle, 1, 0, 0); 
                ctx.translate(0, -pivotY);
            }

            // ç¹ªè£½ (å› ç‚ºæ˜¯ 2000px å…¨ç•«å¸ƒï¼Œæ‰€ä»¥è¦å±…ä¸­å°é½Šåº•éƒ¨)
            ctx.drawImage(l.img, -l.img.width / 2, -l.img.height);
            ctx.restore();
        });

        requestAnimationFrame(draw);
    }
    // --- æ¨¡çµ„ 3: AI è½è¦ºã€ä¸‰æ®µå¼å£å‹èˆ‡å•Ÿå‹•å™¨ ---

    let talkTimer = null;

    // 1. ä¸‰æ®µå¼è¡¨æƒ…æ§åˆ¶ (0=é–‰, 1=åŠé–‹, 2=å…¨é–‹)
    function setMouth(state) {
        const mClose = layers.find(l => l.id === 'mouth_close');
        const mHalf  = layers.find(l => l.id === 'mouth_half');
        const mOpen  = layers.find(l => l.id === 'mouth_open');
        
        if (mClose) mClose.visible = (state === 0);
        if (mHalf)  mHalf.visible  = (state === 1);
        if (mOpen)  mOpen.visible  = (state === 2);
    }

    function resetMouth() {
        if (talkTimer) clearTimeout(talkTimer);
        // è‡ªç„¶è¡°æ¸›ï¼šå…¨é–‹ -> åŠé–‹ -> é–‰å˜´
        talkTimer = setTimeout(() => {
            setMouth(1);
            talkTimer = setTimeout(() => setMouth(0), 100);
        }, 150);
    }

    // 2. å•Ÿå‹• AI èªéŸ³åµæ¸¬ (Silero VAD)
    async function startAISystem() {
        const log = document.getElementById('status-log');
        const meter = document.getElementById('v-meter');
        
        try {
            log.innerText = "æ­£åœ¨åŠ è¼‰ AI æ¨¡å‹...";
            const myVAD = await vad.MicVAD.new({
                onFrameProcessed: (probs) => {
                    const sens = 0.9; // é è¨­ 90% ä¿¡å¿ƒåº¦æ‰é–‹å£
                    meter.style.width = (probs.isSpeech * 100) + "%";

                    if (probs.isSpeech > sens) {
                        setMouth(2); // åµæ¸¬åˆ°äººè² -> å…¨é–‹
                        resetMouth();
                    } else if (probs.isSpeech > 0.4) {
                        setMouth(1); // ç–‘ä¼¼äººè² -> åŠé–‹
                        resetMouth();
                    }
                }
            });
            myVAD.start();
            log.innerText = "AI è½è¦ºå¼•æ“å·²ä¸Šç·š | æŠ¹èŒ¶è²ç´‹é–å®šä¸­";
            log.style.color = "#00ffcc";
        } catch (e) {
            log.innerText = "AI å•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèª HTTPS èˆ‡éº¥å…‹é¢¨";
            console.error(e);
        }
    }

    // 3. è‡ªå‹•çœ¨çœ¼å¾ªç’°
    function startBlink() {
        const op = layers.find(l => l.id === 'eyes_open');
        const cl = layers.find(l => l.id === 'eyes_closed');
        if (op && cl) {
            op.visible = false; cl.visible = true;
            setTimeout(() => {
                op.visible = true; cl.visible = false;
                setTimeout(startBlink, Math.random() * 4000 + 2000);
            }, 150);
        }
    }

    // 4. ç³»çµ±å•Ÿå‹•æŒ‰éˆ• (é»æ“Šä¸€æ¬¡ï¼Œçµ‚èº«æœå‹™)
    document.getElementById('btn-start').onclick = async () => {
        const btn = document.getElementById('btn-start');
        const sID = document.getElementById('stream-id').value;
        
        btn.innerText = "åˆå§‹åŒ–ä¸­..."; btn.disabled = true;

        try {
            // A. è¼‰å…¥ 16 å±¤ V çš®
            await loadResources();
            
            // B. å•Ÿå‹• VDO.Ninja æ©‹æ¥ (æ—¥æœ¬ç•«é¢é€²å ´)
            setupNinjaLink(sID);

            // C. å•Ÿå‹• AI è½è¦º (æ³¨æ„ï¼šé€™æœƒè«‹æ±‚éº¥å…‹é¢¨)
            // åœ¨ OBS å°æ’­ç«¯ï¼Œè«‹ç¢ºä¿é¸æ“‡æ­£ç¢ºçš„è™›æ“¬éŸ³æºæˆ–é›»è…¦è²éŸ³
            await startAISystem();

            // D. å•Ÿå‹•æ¸²æŸ“èˆ‡çœ¨çœ¼
            startBlink();
            draw();

            btn.innerText = "ç³»çµ±å·²å•Ÿå‹• (é›™æ“Šç•«é¢å–šå› UI)";
            btn.style.background = "#55ff55";

            // è‡ªå‹•éš±è— UI
            setTimeout(() => document.getElementById('ui').classList.add('hidden'), 3000);

        } catch (err) {
            alert("å•Ÿå‹•éŒ¯èª¤: " + err.message);
            btn.disabled = false; btn.innerText = "å•Ÿå‹•å¤±æ•—ï¼Œè«‹é‡è©¦";
        }
    };

    // 5. åˆå§‹åŒ–ç•«å¸ƒå°ºå¯¸
    function initCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
    }

    window.onload = initCanvas;
    window.onresize = initCanvas;

    // é›™æ“ŠèƒŒæ™¯å–šå› UI
    document.body.ondblclick = (e) => {
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
            document.getElementById('ui').classList.toggle('hidden');
        }
    };

    console.log("V14.0 Matcha Master Engine Loaded.");
</script>
</body>
</html>
