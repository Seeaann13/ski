<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber V10.2 Final Fix</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        
        /* 全螢幕畫布 */
        canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }

        /* UI 面板 */
        #ui {
            position: absolute; top: 10px; left: 10px; width: 260px; z-index: 100;
            background: rgba(0, 0, 0, 0.85); color: #00d2ff; padding: 15px; 
            border-radius: 12px; border: 1px solid #00d2ff; font-size: 13px;
            backdrop-filter: blur(5px);
        }
        
        label { display: block; margin-top: 8px; color: #fff; font-size: 12px; }
        input[type=range] { width: 100%; accent-color: #00d2ff; margin: 5px 0; }
        
        button { 
            background: #00d2ff; color: #000; border: none; padding: 12px; 
            width: 100%; border-radius: 6px; font-weight: bold; 
            cursor: pointer; margin-top: 15px; font-size: 14px;
        }
        
        .hidden { display: none !important; }
        #status { color: #aaa; font-size: 10px; margin-top: 5px; text-align: center; }
    </style>
</head>
<body>

<canvas id="vtuber-canvas"></canvas>

<div id="ui">
    <div style="text-align:center; font-weight:900; font-size:16px; margin-bottom:10px;">V10.2 完美修正版</div>
    
    <label>1. 風力強度 (Wind):</label>
    <input type="range" id="p-wind" min="0" max="10" step="0.1" value="3.5">
    
    <label>2. 縮放大小 (Scale):</label>
    <input type="range" id="p-scale" min="0.2" max="2.0" step="0.01" value="0.85">
    
    <label>3. 上下位置 (Offset Y):</label>
    <input type="range" id="p-y" min="-500" max="500" step="10" value="100">

    <button id="btn-start">啟動系統</button>
    <button onclick="document.getElementById('ui').classList.add('hidden')" style="background:#444; color:white; margin-top:8px; padding:8px;">隱藏介面</button>
    
    <div id="status">系統準備就緒</div>
</div>

<script>
    // --- 1. 物理物件類別 ---
    class PhysicsLayer {
        constructor(name, img, type, z) {
            this.name = name;
            this.img = img;
            this.type = type; // static, head, hair
            this.z = z;
            
            // 物理狀態
            this.angle = 0;
            this.velocity = 0;
            this.visible = true;
            this.id = name.split('.')[0]; // 預設ID為檔名

            // 物理材質 (質量, 硬度, 阻尼)
            this.mass = 1.0; 
            this.stiffness = 0.1; 
            this.damping = 0.9;

            // 自動根據檔名判斷物理屬性
            if (name.includes('_L')) { // 輕髮
                this.mass = 0.6; this.stiffness = 0.12; this.damping = 0.94;
            } else if (name.includes('_H')) { // 重髮
                this.mass = 2.5; this.stiffness = 0.05; this.damping = 0.85;
            } else if (name.includes('front')) { // 前瀏海 (稍微靈動一點)
                this.mass = 0.7; this.stiffness = 0.15; this.damping = 0.92;
            }
        }

        update(windForce, headMovement) {
            if (this.type === 'static') return;

            // 物理公式：彈簧擺錘
            let targetAngle = (this.type === 'head') ? headMovement : (windForce * (2 - this.mass*0.3));
            
            // 加入慣性 (頭動的時候，頭髮會延遲甩動)
            if (this.type === 'hair') targetAngle += headMovement * this.mass * 0.5;

            const force = (targetAngle - this.angle) * this.stiffness;
            const acceleration = force / this.mass;
            this.velocity = (this.velocity + acceleration) * this.damping;
            this.angle += this.velocity;
        }
    }

    // --- 2. 系統變數 ---
    const canvas = document.getElementById('vtuber-canvas');
    const ctx = canvas.getContext('2d');
    const video = document.createElement('video');
    video.autoplay = true; video.muted = true; video.playsInline = true;
    
    const layers = [];
    let globalTime = 0;

    // --- 3. 檔案清單 (已修正 ID 對應) ---
    const fileList = [
        // 後層與身體
        {n:'jacket_back.png', t:'static', z:5},
        {n:'body.png',        t:'static', z:10},
        
        // 頭部與表情 (注意：ID 必須與下方 toggleFace 對應)
        {n:'head.png',        t:'head',   z:20},
        {n:'ears.png',        t:'head',   z:21},
        {n:'mouth_close.png', t:'head',   z:22, id:'m_close'},
        {n:'mouth_open.png',  t:'head',   z:22, id:'m_open', v:false},
        {n:'eyes_open.png',   t:'head',   z:23, id:'e_open'},
        {n:'eyes_closed.png', t:'head',   z:23, id:'e_closed', v:false},
        
        // 頭髮 (自動物理)
        {n:'hair_base.png',   t:'hair',   z:25},
        {n:'hair_H1.png',     t:'hair',   z:26},
        {n:'hair_H2.png',     t:'hair',   z:26},
        {n:'hair_M1.png',     t:'hair',   z:27},
        {n:'hair_M2.png',     t:'hair',   z:27},
        {n:'hair_L1.png',     t:'hair',   z:28},
        
        // 前瀏海
        {n:'layer-front1.png',t:'hair',   z:30},
        {n:'layer-front2.png',t:'hair',   z:30}
    ];

    // --- 4. 資源載入 ---
    async function loadAll() {
        const status = document.getElementById('status');
        let loaded = 0;
        
        for (let f of fileList) {
            await new Promise(resolve => {
                const img = new Image();
                img.src = f.n;
                img.onload = () => {
                    const l = new PhysicsLayer(f.n, img, f.t, f.z);
                    if (f.id) l.id = f.id; // ★關鍵修正：確保ID正確載入
                    if (f.v !== undefined) l.visible = f.v;
                    layers.push(l);
                    loaded++;
                    status.innerText = `載入中: ${Math.round(loaded/fileList.length*100)}%`;
                    resolve();
                };
                img.onerror = () => {
                    console.log("缺圖 (沒關係，自動跳過): " + f.n);
                    resolve(); 
                };
            });
        }
        layers.sort((a,b) => a.z - b.z);
        status.innerText = "資源載入完成";
        draw(); 
    }

    // --- 5. 繪圖核心 ---
    function draw() {
        // 設定高畫質畫布
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        const w = window.innerWidth;
        const h = window.innerHeight;

        ctx.clearRect(0,0,w,h);

        // 畫相機背景
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const s = Math.max(w / video.videoWidth, h / video.videoHeight);
            ctx.drawImage(video, (w - video.videoWidth*s)/2, (h - video.videoHeight*s)/2, video.videoWidth*s, video.videoHeight*s);
        }

        // 計算全域物理
        globalTime += 0.05;
        const windVal = parseFloat(document.getElementById('p-wind').value);
        // 風力 = 基礎風 + 隨機陣風
        const wind = (windVal * 0.02) + (Math.sin(globalTime * 0.5) * 0.01) + (Math.sin(globalTime * 2.3) * 0.005);
        // 頭部呼吸擺動
        const headSway = Math.sin(globalTime * 0.5) * 0.03;
        
        // 取得 UI 參數
        const scale = parseFloat(document.getElementById('p-scale').value);
        const offsetY = parseFloat(document.getElementById('p-y').value);

        // 繪製每一層
        layers.forEach(l => {
            if (!l.visible) return;
            l.update(wind, headSway);

            ctx.save();
            // 1. 移動到螢幕底部中央
            ctx.translate(w / 2, h + offsetY);
            // 2. 縮放
            ctx.scale(scale, scale);
            
            // 3. 旋轉 (關鍵：圖片中心對齊畫布中心，但旋轉點上移)
            // 這裡假設你的頭部約在圖片高度的 25%~30% 處 (從上往下算)
            const pivotY = -l.img.height * 0.75; 
            
            if (l.type !== 'static') {
                ctx.translate(0, pivotY); // 移到頭頂
                ctx.rotate(l.angle);      // 旋轉
                ctx.translate(0, -pivotY);// 移回來
            }

            // 4. 畫圖 (以底部中心為基準)
            ctx.drawImage(l.img, -l.img.width / 2, -l.img.height);
            
            ctx.restore();
        });

        requestAnimationFrame(draw);
    }

    // --- 6. 表情控制 (★修正後版本) ---
    function toggleFace(part, isOpen) {
        // 這裡的 ID 必須跟 fileList 裡的 id 設定一模一樣
        const openId = part === 'mouth' ? 'm_open' : 'e_open';
        const closeId = part === 'mouth' ? 'm_close' : 'e_closed';
        
        const openL = layers.find(l => l.id === openId);
        const closeL = layers.find(l => l.id === closeId);
        
        if (openL && closeL) {
            openL.visible = isOpen;
            closeL.visible = !isOpen;
        }
    }

    // 自動眨眼
    function autoBlink() {
        toggleFace('eyes', false); // 閉眼 (顯示 e_closed)
        setTimeout(() => {
            toggleFace('eyes', true); // 張眼 (顯示 e_open)
            setTimeout(autoBlink, Math.random() * 3000 + 2000);
        }, 150);
    }

    // --- 7. 啟動與音訊 ---
    document.getElementById('btn-start').onclick = async () => {
        try {
            // 啟動相機
            const vStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = vStream;

            // 啟動麥克風
            const aStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioCtx = new AudioContext();
            const analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaStreamSource(aStream);
            const script = audioCtx.createScriptProcessor(2048, 1, 1);
            
            src.connect(analyser); analyser.connect(script); script.connect(audioCtx.destination);
            
            script.onaudioprocess = () => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b) / data.length;
                
                // 說話閥值 (可調)
                if (vol > 20) {
                    toggleFace('mouth', true);
                    clearTimeout(window.talkT);
                    window.talkT = setTimeout(() => toggleFace('mouth', false), 150);
                }
            };

            autoBlink();
            document.getElementById('btn-start').innerText = "系統運作中";
            document.getElementById('btn-start').style.background = "#55ff55";
        } catch(e) {
            alert("啟動失敗: " + e.message);
        }
    };

    // 初始化
    window.onload = loadAll;

</script>
</body>
</html>
