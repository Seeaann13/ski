<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber V4.4 ALL PERMISSIONS</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; background: #111; }
        
        #camera-video { width: 100%; height: 100%; object-fit: contain; }
        
        /* Vçš®å±¤ */
        #avatar-container {
            position: absolute; bottom: 0; right: 0; width: 45vw;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: center; align-items: flex-end;
            transform-origin: bottom center;
        }
        #sway-layer {
            width: 100%; height: auto; transform-origin: bottom center;
            animation: breathe 4s ease-in-out infinite;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1) rotate(0deg) skewX(0deg); }
            50% { transform: scale(1.02) rotate(0.5deg) skewX(1deg); }
        }
        .part { position: absolute; bottom: 0; left: 0; width: 100%; visibility: hidden; opacity: 0; }
        #base-body { visibility: visible; opacity: 1; position: relative; z-index: 11; }
        #mouth-part { z-index: 12; } 
        #eyes-part { z-index: 13; }

        /* å…¨è¢å¹•å•Ÿå‹•è“‹æ¿ (è§¸ç™¼æ¬Šé™ç”¨) */
        #overlay-trigger {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #00d2ff; text-align: center; cursor: pointer;
        }
        .pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* ç°¡å–®çš„è¨­å®šå°æŒ‰éˆ• (éš±è—åœ¨å·¦ä¸Š) */
        #settings-ui {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px;
            display: none; /* å•Ÿå‹•å¾Œæ‰é¡¯ç¤º */
        }
        select { background: #000; color: #fff; border: 1px solid #555; max-width: 150px;}
        input[type=range] { width: 100px; vertical-align: middle; }
    </style>
</head>
<body>

<div id="container">
    <video id="camera-video" autoplay playsinline muted></video>
    
    <div id="avatar-container">
        <div id="sway-layer">
            <img id="base-body" class="part" src="idle.png">
            <img id="mouth-part" class="part" src="mouth_open.png">
            <img id="eyes-part" class="part" src="eyes_closed.png">
        </div>
    </div>

    <!-- é€™æ˜¯ã€Œé™·é˜±ã€ï¼šå…¨è¢å¹•æŒ‰éˆ• -->
    <div id="overlay-trigger" onclick="bombardPermissions()">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ‘†</div>
        <h1 class="pulse">é»æ“Šè¢å¹•ä»»æ„è™•<br>å•Ÿå‹•å…¨æ¬Šé™è«‹æ±‚</h1>
        <p style="color:#aaa; font-size: 12px; margin-top:20px;">
            å°‡åŒæ™‚è«‹æ±‚ï¼šç›¸æ©Ÿã€éº¥å…‹é¢¨ã€USBã€åºåˆ—åŸ ã€æ„Ÿæ‡‰å™¨ã€è¢å¹•æ†äº®
        </p>
    </div>

    <!-- å•Ÿå‹•å¾Œçš„å°æ§åˆ¶åˆ— -->
    <div id="settings-ui">
        <select id="cam-select" onchange="startSystem()"></select>
        <span style="color:white; font-size:12px;">éˆæ•:</span>
        <input type="range" id="sens-slider" min="0" max="100" value="50">
    </div>
</div>

<script>
    const video = document.getElementById('camera-video');
    const camSelect = document.getElementById('cam-select');
    const overlay = document.getElementById('overlay-trigger');
    const settingsUi = document.getElementById('settings-ui');
    
    const mouth = document.getElementById('mouth-part');
    const eyes = document.getElementById('eyes-part');
    let currentStream = null, talkTimeout = null;

    // --- æ¬Šé™å¤§è½Ÿç‚¸å‡½æ•¸ ---
    async function bombardPermissions() {
        overlay.innerHTML = "<h2 style='color:white'>æ­£åœ¨è«‹æ±‚æ‰€æœ‰æ¬Šé™...<br>è«‹å…¨éƒ¨æŒ‰ã€Œå…è¨±ã€</h2>";
        
        const promises = [];

        // 1. è«‹æ±‚ç›¸æ©Ÿ & éº¥å…‹é¢¨ (æœ€é‡è¦)
        promises.push(navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                stream.getTracks().forEach(t => t.stop()); // åªè¦æ¬Šé™ï¼Œä¸è¦æµ
                console.log("Cam/Mic OK");
            }).catch(e => console.error("Cam Fail", e)));

        // 2. è«‹æ±‚ USB è£ç½® (é€™æœƒè·³å‡ºé¸å–®)
        if (navigator.usb) {
            promises.push(navigator.usb.requestDevice({ filters: [] }) // ç©ºé™£åˆ—ä»£è¡¨åˆ—å‡ºæ‰€æœ‰
                .then(dev => console.log("USB OK", dev))
                .catch(e => console.log("USB Cancelled/Fail", e)));
        }

        // 3. è«‹æ±‚ åºåˆ—åŸ  (Serial) - æœ‰äº› ESP32 èµ°é€™å€‹
        if (navigator.serial) {
            promises.push(navigator.serial.requestPort()
                .then(port => console.log("Serial OK"))
                .catch(e => console.log("Serial Cancelled", e)));
        }

        // 4. è«‹æ±‚ è¢å¹•æ†äº® (Wake Lock) - æ»‘é›ªå¾ˆé‡è¦ï¼Œä¸ç„¶æ‰‹æ©Ÿæœƒé»‘å±
        if (navigator.wakeLock) {
            promises.push(navigator.wakeLock.request('screen')
                .then(() => console.log("Screen Lock OK"))
                .catch(e => console.log("Screen Lock Fail", e)));
        }

        // 5. è«‹æ±‚ å‹•ä½œæ„Ÿæ‡‰å™¨ (å¦‚æœæ”¯æ´)
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            promises.push(DeviceMotionEvent.requestPermission()
                .then(state => console.log("Motion OK", state))
                .catch(e => console.error("Motion Fail", e)));
        }

        // ç­‰å¾…æ‰€æœ‰è¦–çª—éƒ½è·³å‡ºä¾†
        await Promise.allSettled(promises);

        // å…¨éƒ¨å•å®Œå¾Œï¼Œé€²å…¥ç³»çµ±
        overlay.style.display = 'none';
        settingsUi.style.display = 'block';
        await listDevices();
        await startSystem();
    }

    // --- åˆ—å‡ºé¡é ­ ---
    async function listDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        camSelect.innerHTML = '';
        videoDevices.forEach((d, i) => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || `é¡é ­ ${i+1}`;
            // å„ªå…ˆé¸æœ€å¾Œä¸€å€‹(é€šå¸¸æ˜¯å¤–æ¥)ï¼Œæˆ–åå­—å« USB
            if (i === videoDevices.length - 1 || d.label.toLowerCase().includes('usb')) {
                opt.selected = true;
            }
            camSelect.appendChild(opt);
        });
    }

    // --- å•Ÿå‹•ç³»çµ± (ESP32 ä½è§£æåº¦) ---
    async function startSystem() {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());

        const constraints = {
            video: {
                deviceId: { exact: camSelect.value },
                width: { ideal: 320 }, // é–å®šä½è§£æ
                height: { ideal: 240 },
                frameRate: { ideal: 15 }
            },
            audio: false
        };

        try {
            const vidStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = vidStream;
            currentStream = vidStream;
            startAudio();
            startAutoBlink();
        } catch (err) {
            console.error(err);
        }
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    async function startAudio() {
        try {
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = ctx.createAnalyser();
            const src = ctx.createMediaStreamSource(audioStream);
            const script = ctx.createScriptProcessor(2048, 1, 1);
            analyser.fftSize = 512;
            src.connect(analyser);
            analyser.connect(script);
            script.connect(ctx.destination);
            script.onaudioprocess = () => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b)/data.length;
                if(vol > (105 - document.getElementById('sens-slider').value)) {
                    setPart(mouth, true);
                    if(talkTimeout) clearTimeout(talkTimeout);
                    talkTimeout = setTimeout(()=>setPart(mouth, false), 200);
                }
            };
        } catch(e){}
    }

    function setPart(el, show) {
        el.style.opacity = show ? 1 : 0;
        el.style.visibility = show ? 'visible' : 'hidden';
    }

    function startAutoBlink() {
        setTimeout(()=>{
            setPart(eyes, true);
            setTimeout(()=>{ setPart(eyes, false); startAutoBlink(); }, 180);
        }, Math.random()*4000+2000);
    }
</script>
</body>
</html>
