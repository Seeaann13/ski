<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matcha Ski V13.2 Fast Boot</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web/dist/bundle.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; background: #000; }
        
        /* 背景串流 iframe */
        iframe#ninja-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none; z-index: 0; pointer-events: none; transform: scale(1.02);
        }
        
        /* 前景 Canvas */
        canvas#vtuber-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        /* UI */
        #ui {
            position: absolute; top: 15px; left: 15px; width: 260px; z-index: 100;
            background: rgba(0, 0, 0, 0.9); color: #00d2ff; padding: 15px; 
            border-radius: 15px; border: 1px solid #00d2ff; font-size: 13px;
        }
        .hidden { display: none !important; }
        label { display: block; margin-top: 8px; color: #888; font-size: 11px; }
        input[type=range] { width: 100%; accent-color: #00d2ff; }
        #btn-start { 
            background: #00d2ff; color: #000; border: none; padding: 12px; width: 100%; 
            border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        #status-log { color: #ffaa00; font-size: 10px; text-align: center; margin-top: 5px; min-height: 15px; }
        
        .meter-box { width: 100%; height: 5px; background: #333; margin-top: 5px; }
        #v-meter { height: 100%; width: 0%; background: #00ff00; transition: width 0.05s; }
    </style>
</head>
<body>

<!-- 背景 Ninja -->
<iframe id="ninja-bg" allow="autoplay; microphone; camera; display-capture"></iframe>
<canvas id="vtuber-canvas"></canvas>

<div id="ui">
    <div style="text-align:center; font-weight:900;">V13.2 急速啟動版</div>
    
    <label>1. 滑雪場 ID:</label>
    <input type="text" id="stream-id" value="sean1357" style="width:100%; background:#222; color:#fff; border:1px solid #444; padding:5px;">

    <label>2. 聲音反應:</label>
    <div class="meter-box"><div id="v-meter"></div></div>
    <input type="range" id="p-sens" min="0" max="100" value="70">
    
    <label>3. 物理風力:</label>
    <input type="range" id="p-wind" min="0" max="10" step="0.1" value="3.0">

    <label>4. 位置/縮放:</label>
    <div style="display:flex; gap:5px;">
        <input type="range" id="p-x" min="-400" max="400" value="0">
        <input type="range" id="p-y" min="-400" max="400" value="100">
    </div>
    <input type="range" id="p-scale" min="0.2" max="2.0" step="0.01" value="0.85">

    <button id="btn-start">啟動系統</button>
    <div id="status-log">等待指令...</div>
    
    <button onclick="document.getElementById('ui').classList.add('hidden')" style="width:100%; background:transparent; border:1px solid #555; color:#888; padding:5px; margin-top:10px; font-size:10px;">隱藏介面</button>
</div>

<script>
    // --- 1. 自動背景載入 ---
    const ninjaFrame = document.getElementById('ninja-bg');
    const streamID = document.getElementById('stream-id').value; 
    // 這裡我們預設載入 sean1357，並加上 &novideo=0 確保有影像
    ninjaFrame.src = `https://vdo.ninja/?view=${streamID}&autoplay=1&cleanoutput=1&transparent=0`;

    // 參數偵測
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('obs')) document.getElementById('ui').style.display = 'none';

    // --- 2. 物理與資源 ---
    class PhysicsLayer {
        constructor(name, img, type, z) {
            this.name = name; this.img = img; this.type = type; this.z = z;
            this.angle = 0; this.vel = 0; this.visible = true; this.id = name.split('.')[0];
            this.mass = 1.0; this.stiffness = 0.1; this.damping = 0.9;
            if (name.includes('_L')) { this.mass = 0.6; this.stiffness = 0.15; }
            if (name.includes('_H')) { this.mass = 2.5; this.stiffness = 0.05; }
            if (name.includes('front')) { this.mass = 0.8; this.stiffness = 0.12; }
        }
        update(wind, headSway) {
            if (this.type === 'static') return;
            if (this.type === 'head' || this.type === 'face') { this.angle = headSway; return; }
            let target = (wind * (2 - this.mass*0.3)) + (headSway * this.mass * 0.5);
            let force = (target - this.angle) * this.stiffness;
            let acc = force / this.mass;
            this.vel = (this.vel + acc) * this.damping;
            this.angle += this.vel;
        }
    }

    const canvas = document.getElementById('vtuber-canvas');
    const ctx = canvas.getContext('2d');
    const layers = [];
    let globalTime = 0;

    const fileList = [
        {n:'jacket_back.png', t:'static', z:10},
        {n:'head.png',        t:'head',   z:15},
        {n:'body.png',        t:'static', z:20},
        {n:'ears.png',        t:'head',   z:25},
        {n:'mouth_close.png', t:'face',   z:26, id:'m_close'},
        {n:'mouth_open.png',  t:'face',   z:26, id:'m_open', v:false},
        {n:'eyes_open.png',   t:'face',   z:27, id:'e_open'},
        {n:'eyes_closed.png', t:'face',   z:27, id:'e_closed', v:false},
        {n:'hair_base.png',   t:'hair',   z:30},
        {n:'hair_H1.png',     t:'hair',   z:31}, {n:'hair_H2.png', t:'hair', z:31},
        {n:'hair_M1.png',     t:'hair',   z:32}, {n:'hair_M2.png', t:'hair', z:32},
        {n:'hair_L1.png',     t:'hair',   z:33},
        {n:'layer-front1.png',t:'hair',   z:40}, {n:'layer-front2.png',t:'hair',   z:40}
    ];

    async function loadResources() {
        let count = 0;
        document.getElementById('status-log').innerText = "下載 V 皮圖層中...";
        for (let f of fileList) {
            await new Promise(r => {
                const img = new Image(); img.src = f.n + "?t=" + Date.now();
                img.onload = () => {
                    const l = new PhysicsLayer(f.n, img, f.t, f.z);
                    if (f.id) l.id = f.id; if (f.v !== undefined) l.visible = f.v;
                    layers.push(l); count++; r();
                };
                img.onerror = () => { console.log("缺圖跳過: "+f.n); r(); };
            });
        }
        layers.sort((a,b) => a.z - b.z);
    }

    // --- 3. 繪圖迴圈 ---
    function draw() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        ctx.clearRect(0,0, window.innerWidth, window.innerHeight);

        globalTime += 0.05;
        const wind = (parseFloat(document.getElementById('p-wind').value) * 0.02) + (Math.sin(globalTime*0.7)*0.01);
        const headSway = Math.sin(globalTime * 0.5) * 0.03;
        const scale = parseFloat(document.getElementById('p-scale').value);
        const offX = parseFloat(document.getElementById('p-x').value);
        const offY = parseFloat(document.getElementById('p-y').value);

        layers.forEach(l => {
            if (!l.visible) return;
            l.update(wind, headSway);
            ctx.save();
            ctx.translate(window.innerWidth/2 + offX, window.innerHeight + offY);
            ctx.scale(scale, scale);
            const pivotY = -l.img.height * 0.7; 
            if (l.type !== 'static') {
                ctx.translate(0, pivotY); ctx.transform(1, 0, l.angle, 1, 0, 0); ctx.translate(0, -pivotY);
            }
            ctx.drawImage(l.img, -l.img.width/2, -l.img.height);
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    // --- 4. 聽覺 (AI + 備援) ---
    let talkTimer = null;
    function setFace(part, isOpen) {
        const oId = part==='mouth'?'m_open':'e_open'; const cId = part==='mouth'?'m_close':'e_closed';
        const op = layers.find(l=>l.id===oId); const cl = layers.find(l=>l.id===cId);
        if(op&&cl){ op.visible=isOpen; cl.visible=!isOpen; }
    }

    // ★ 關鍵：帶有超時機制的 AI 啟動器 ★
    async function startSmartAudio() {
        const status = document.getElementById('status-log');
        
        // 1. 先嘗試啟動備援 (AudioContext)，確保至少有聲音輸入
        let audioCtx;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // 這裡不綁定分析器，只為了喚醒權限
        } catch(e) {
            alert("請允許麥克風權限！");
            return;
        }

        // 2. 嘗試並行下載 AI，設定 8 秒超時
        status.innerText = "嘗試載入 AI 模型 (限時 8 秒)...";
        
        const aiPromise = vad.MicVAD.new({
            onFrameProcessed: (probs) => {
                // AI 成功運作中
                const sens = 1.0 - (document.getElementById('p-sens').value/100);
                document.getElementById('v-meter').style.width = (probs.isSpeech*100)+"%";
                if (probs.isSpeech > sens) {
                    setFace('mouth', true);
                    if (talkTimer) clearTimeout(talkTimer);
                    talkTimer = setTimeout(() => setFace('mouth', false), 150);
                }
            }
        });

        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error("TIMEOUT")), 8000)
        );

        try {
            const myVAD = await Promise.race([aiPromise, timeoutPromise]);
            myVAD.start();
            status.innerText = "AI 模式運作中 (最佳)";
            status.style.color = "#00ff00";
        } catch (err) {
            console.warn("AI 啟動超時或失敗，切換備援:", err);
            status.innerText = "備援模式 (頻率偵測)";
            startFallbackMode(audioCtx); // 啟動備援
        }
    }

    // 備援頻率模式
    async function startFallbackMode(existingCtx) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = existingCtx || new AudioContext();
            const ana = ctx.createAnalyser();
            const src = ctx.createMediaStreamSource(stream);
            const script = ctx.createScriptProcessor(2048, 1, 1);
            src.connect(ana); ana.connect(script); script.connect(ctx.destination);
            
            script.onaudioprocess = () => {
                const data = new Uint8Array(ana.frequencyBinCount);
                ana.getByteFrequencyData(data);
                let sum = 0; for(let i=5;i<50;i++) sum+=data[i];
                const vol = sum/45;
                document.getElementById('v-meter').style.width = Math.min(vol*2, 100)+"%";
                if (vol > (105-document.getElementById('p-sens').value)) {
                    setFace('mouth', true);
                    if (talkTimer) clearTimeout(talkTimer);
                    talkTimer = setTimeout(() => setFace('mouth', false), 150);
                }
            };
        } catch(e) { console.error(e); }
    }

    function autoBlink() {
        setFace('eyes', false);
        setTimeout(() => { setFace('eyes', true); setTimeout(autoBlink, Math.random()*3000+2000); }, 150);
    }

    // --- 5. 啟動按鈕 ---
    document.getElementById('btn-start').onclick = async () => {
        const btn = document.getElementById('btn-start');
        btn.innerText = "初始化中..."; btn.disabled = true;
        
        // 1. 載資源
        await loadResources();
        
        // 2. 啟動聽覺 (含超時保護)
        await startSmartAudio();
        
        // 3. 啟動視覺
        autoBlink();
        draw();
        
        btn.innerText = "系統運作中";
        btn.style.background = "#55ff55";
        
        // 5秒後自動隱藏 UI
        setTimeout(() => document.getElementById('ui').classList.add('hidden'), 5000);
    };

    // 雙擊喚回 UI
    document.body.ondblclick = (e) => {
        if(e.target.tagName!=='BUTTON'&&e.target.tagName!=='INPUT') document.getElementById('ui').classList.toggle('hidden');
    };
    
    // 初始化
    function setupCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        canvas.style.width = window.innerWidth+'px'; canvas.style.height = window.innerHeight+'px';
        ctx.scale(dpr, dpr);
    }
    window.onload = setupCanvas; window.onresize = setupCanvas;

</script>
</body>
</html>
