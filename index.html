<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ski-VTuber V4.2 Total Access</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; background: #111; }
        
        #camera-video { width: 100%; height: 100%; object-fit: contain; }
        
        /* V皮層 (保留飄動效果) */
        #avatar-container {
            position: absolute; bottom: 0; right: 0; width: 45vw;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: center; align-items: flex-end;
            transform-origin: bottom center;
        }
        #sway-layer {
            width: 100%; height: auto; transform-origin: bottom center;
            animation: breathe 4s ease-in-out infinite;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1) rotate(0deg) skewX(0deg); }
            50% { transform: scale(1.02) rotate(0.5deg) skewX(1deg); }
        }
        .part { position: absolute; bottom: 0; left: 0; width: 100%; visibility: hidden; opacity: 0; }
        #base-body { visibility: visible; opacity: 1; position: relative; z-index: 11; }
        #mouth-part { z-index: 12; } 
        #eyes-part { z-index: 13; }

        /* UI */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; padding: 20px; box-sizing: border-box;
        }
        
        /* 隱藏 UI 時的狀態 */
        #ui-layer.minimized {
            height: auto; bottom: 0; top: auto; background: rgba(0,0,0,0.5);
            display: block; padding: 10px;
        }
        #ui-layer.minimized .full-controls { display: none; }
        #ui-layer.minimized #restore-btn { display: block; }

        button { padding: 15px 30px; background: #00d2ff; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; margin: 10px 0; width: 100%; max-width: 300px; }
        button.red { background: #ff4444; color: white; }
        select { padding: 10px; background: #333; color: white; border: 1px solid #666; width: 100%; max-width: 300px; margin-bottom: 10px;}
        
        #status-log { color: #aaa; font-size: 12px; margin-top: 10px; text-align: center; }
        #restore-btn { display: none; width: 100%; background: transparent; color: #00d2ff; border: 1px solid #00d2ff; }
    </style>
</head>
<body>

<div id="container">
    <video id="camera-video" autoplay playsinline muted></video>
    
    <div id="avatar-container">
        <div id="sway-layer">
            <img id="base-body" class="part" src="idle.png">
            <img id="mouth-part" class="part" src="mouth_open.png">
            <img id="eyes-part" class="part" src="eyes_closed.png">
        </div>
    </div>

    <div id="ui-layer">
        <div class="full-controls" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <h2 style="color:#00d2ff;">權限暴力請求版 V4.2</h2>
            
            <!-- 步驟 1 -->
            <button onclick="askAllPermissions()">1. 按我！一次請求所有權限</button>
            <div id="status-log">等待操作...</div>

            <hr style="width:100%; border-color:#333; margin: 20px 0;">

            <!-- 步驟 2 -->
            <label>2. 選擇鏡頭 (USB通常在最後):</label>
            <select id="cam-select"><option>請先完成步驟 1</option></select>
            
            <!-- 步驟 3 -->
            <button id="start-btn" onclick="startSystem()" disabled style="background:#555;">3. 啟動系統 (320x240)</button>

            <div style="width:100%; max-width:300px; margin-top:10px;">
                口型靈敏度: <input type="range" id="sens-slider" min="0" max="100" value="50" style="width:100%;">
            </div>
            
            <button class="red" onclick="minimizeUI()">開始直播 (隱藏介面)</button>
        </div>

        <button id="restore-btn" onclick="restoreUI()">顯示設定面板</button>
    </div>
</div>

<script>
    const video = document.getElementById('camera-video');
    const camSelect = document.getElementById('cam-select');
    const statusLog = document.getElementById('status-log');
    const startBtn = document.getElementById('start-btn');
    const uiLayer = document.getElementById('ui-layer');
    
    const mouth = document.getElementById('mouth-part');
    const eyes = document.getElementById('eyes-part');
    let currentStream = null, talkTimeout = null;

    // --- 1. 暴力請求所有權限 ---
    async function askAllPermissions() {
        statusLog.innerText = "正在請求 相機+麥克風 權限...";
        try {
            // 這行代碼會強制瀏覽器跳出詢問視窗
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: true 
            });
            
            // 拿到權限後，先把流關掉，因為我們要重新選擇特定的 USB 鏡頭
            stream.getTracks().forEach(track => track.stop());
            
            statusLog.innerText = "權限已獲取！正在掃描 USB 設備...";
            statusLog.style.color = "#55ff55";
            
            // 權限拿到後，列舉設備才能看到名稱
            await listDevices();

        } catch (err) {
            console.error(err);
            statusLog.innerText = "失敗: " + err.name;
            statusLog.style.color = "#ff4444";
            alert("請求失敗！\n請確認：\n1. 你的 USB 鏡頭沒有被其他 App 佔用 (請關閉所有背景 App)\n2. 瀏覽器設定中沒有封鎖相機");
        }
    }

    // --- 2. 列出設備 ---
    async function listDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        
        camSelect.innerHTML = '';
        if (videoDevices.length === 0) {
            camSelect.innerHTML = '<option>找不到鏡頭</option>';
            return;
        }

        videoDevices.forEach((d, i) => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || `Camera ${i+1}`;
            // 嘗試自動選取 USB 設備 (通常是最後一個，或者名字含 USB)
            if (i === videoDevices.length - 1 || d.label.toLowerCase().includes('usb')) {
                opt.selected = true;
            }
            camSelect.appendChild(opt);
        });

        startBtn.disabled = false;
        startBtn.style.background = "#00d2ff";
        startBtn.innerText = "3. 啟動系統 (320x240)";
    }

    // --- 3. 啟動系統 (針對 ESP32 優化) ---
    async function startSystem() {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());

        const constraints = {
            video: {
                deviceId: { exact: camSelect.value },
                // ESP32-S3 只能跑這個解析度，別調高
                width: { ideal: 320 },
                height: { ideal: 240 },
                frameRate: { ideal: 15, max: 30 }
            },
            audio: false // 這裡不抓音訊，音訊另外抓
        };

        try {
            statusLog.innerText = "正在連接 USB 鏡頭...";
            const vidStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = vidStream;
            currentStream = vidStream;
            statusLog.innerText = "畫面已啟動！";
            
            // 啟動麥克風監聽
            startAudio();
            // 啟動眨眼
            startAutoBlink();

        } catch (err) {
            statusLog.innerText = "啟動錯誤: " + err.message;
            alert("無法啟動選定的鏡頭。\n如果是 USB 鏡頭，請嘗試重新插拔，並確認其他 App 已關閉。");
        }
    }

    // --- 輔助功能 ---
    async function startAudio() {
        try {
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = ctx.createAnalyser();
            const src = ctx.createMediaStreamSource(audioStream);
            const script = ctx.createScriptProcessor(2048, 1, 1);
            
            analyser.fftSize = 512;
            src.connect(analyser);
            analyser.connect(script);
            script.connect(ctx.destination);
            
            script.onaudioprocess = () => {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b)/data.length;
                const thres = 105 - document.getElementById('sens-slider').value;
                if(vol > thres) {
                    setPart(mouth, true);
                    if(talkTimeout) clearTimeout(talkTimeout);
                    talkTimeout = setTimeout(()=>setPart(mouth, false), 200);
                }
            };
        } catch(e){}
    }

    function setPart(el, show) {
        el.style.opacity = show ? 1 : 0;
        el.style.visibility = show ? 'visible' : 'hidden';
    }

    function startAutoBlink() {
        setTimeout(()=>{
            setPart(eyes, true);
            setTimeout(()=>{ setPart(eyes, false); startAutoBlink(); }, 180);
        }, Math.random()*4000+2000);
    }

    function minimizeUI() {
        uiLayer.classList.add('minimized');
    }
    function restoreUI() {
        uiLayer.classList.remove('minimized');
    }
</script>
</body>
</html>
